<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>学園女子プロレス シミュレーター</title>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Noto+Sans+JP:wght@400;700;900&family=Oswald:wght@400;600;700&display=swap" rel="stylesheet">
<style>
/* ═══ VARIABLES & RESET ═══ */
:root {
  --bg-dark: #08080d;
  --card-bg: #0e0e15;
  --gold: #d4a843;
  --gold-light: #f0d078;
  --gold-dim: rgba(212,168,67,0.5);
  --blue: #1a3a6b;
  --blue-dark: #0d1f3c;
  --blue-glow: rgba(26,58,107,0.4);
  --red: #c41e3a;
  --red-dark: #8b1528;
  --red-glow: rgba(196,30,58,0.4);
  --text-main: #e7e9ee;
  --text-sub: rgba(255,255,255,0.5);
  --text-dim: rgba(255,255,255,0.25);
  color-scheme: dark;
}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Noto Sans JP',sans-serif;background:var(--bg-dark);color:var(--text-main);min-height:100vh;
  background-image:radial-gradient(ellipse 80% 50% at 50% 0%,rgba(196,30,58,0.05) 0%,transparent 60%),
  radial-gradient(ellipse 60% 40% at 80% 100%,rgba(26,58,107,0.04) 0%,transparent 50%)}
.app{max-width:1400px;margin:0 auto;padding:20px}
::-webkit-scrollbar{width:5px}
::-webkit-scrollbar-track{background:rgba(0,0,0,0.3)}
::-webkit-scrollbar-thumb{background:rgba(212,168,67,0.3);border-radius:3px}

/* ═══ HEADER ═══ */
.site-header{text-align:center;padding:30px 20px 20px;margin-bottom:8px}
.site-header::after{content:'';display:block;width:100px;height:1px;
  background:linear-gradient(90deg,transparent,var(--gold),transparent);margin:16px auto 0}
.site-title{font-family:'Bebas Neue',sans-serif;font-size:48px;letter-spacing:8px;
  background:linear-gradient(180deg,#fff 20%,var(--gold-light) 100%);
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;line-height:1.1}
.site-subtitle{font-family:'Oswald',sans-serif;font-size:11px;letter-spacing:5px;
  text-transform:uppercase;color:var(--gold);opacity:0.5;margin-top:6px}

/* ═══ SELECT: MATCHUP ═══ */
.matchup-indicator{display:flex;align-items:center;justify-content:center;gap:20px;margin:20px auto 12px;max-width:700px}
.matchup-slot{flex:1;padding:12px 16px;background:var(--card-bg);border:1px solid rgba(255,255,255,0.08);
  border-radius:3px;text-align:center;font-size:14px;font-weight:700;transition:all .3s;
  min-height:48px;display:flex;flex-direction:column;align-items:center;justify-content:center}
.matchup-slot.left{border-color:rgba(74,143,212,0.2)}
.matchup-slot.left.filled{border-color:rgba(74,143,212,0.5);box-shadow:0 0 15px rgba(74,143,212,0.15);color:#8bc4f0}
.matchup-slot.right{border-color:rgba(196,30,58,0.2)}
.matchup-slot.right.filled{border-color:rgba(196,30,58,0.5);box-shadow:0 0 15px rgba(196,30,58,0.15);color:#f08b9e}
.slot-label{font-family:'Oswald',sans-serif;font-size:9px;letter-spacing:3px;text-transform:uppercase;display:block;margin-bottom:4px}
.matchup-slot.left .slot-label{color:rgba(74,143,212,0.6)}
.matchup-slot.right .slot-label{color:rgba(196,30,58,0.6)}
.slot-empty{color:var(--text-dim);font-weight:400}
.matchup-vs{font-family:'Bebas Neue',sans-serif;font-size:28px;color:var(--gold);opacity:0.6;flex-shrink:0}

/* ═══ SELECT: FIGHT BUTTON ═══ */
.fight-btn-wrap{text-align:center;margin:0 0 20px}
.btn-fight{font-family:'Bebas Neue',sans-serif;font-size:28px;letter-spacing:6px;padding:14px 0;
  width:min(600px,80%);border:none;border-radius:3px;cursor:pointer;
  background:linear-gradient(135deg,var(--gold),#b8912e);color:var(--bg-dark);transition:all .2s;
  position:relative;overflow:hidden}
.btn-fight::before{content:'';position:absolute;top:0;left:-100%;right:0;bottom:0;width:300%;
  background:linear-gradient(90deg,transparent,rgba(255,255,255,0.15),transparent);transition:left .5s}
.btn-fight:hover:not(:disabled)::before{left:100%}
.btn-fight:hover:not(:disabled){filter:brightness(1.15);transform:translateY(-1px);box-shadow:0 4px 20px rgba(212,168,67,0.3)}
.btn-fight:disabled{opacity:0.3;cursor:not-allowed}
.btn-fight-sub{display:block;font-family:'Noto Sans JP',sans-serif;font-size:11px;letter-spacing:1px;opacity:0.7;margin-top:2px}

/* ═══ SELECT: ROSTER GRID ═══ */
.roster-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:18px;margin-bottom:24px}

/* ═══ CHARACTER CARD ═══ */
.char-card{background:var(--card-bg);border:1px solid rgba(255,255,255,0.08);border-radius:4px;
  overflow:hidden;position:relative;opacity:0;transform:translateY(20px);
  animation:cardIn .5s ease forwards;transition:all .4s}
@keyframes cardIn{to{opacity:1;transform:translateY(0)}}
.char-card::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;
  background:linear-gradient(90deg,transparent,var(--gold) 50%,transparent);opacity:0;transition:opacity .3s;z-index:3}
.char-card:hover::before{opacity:1}
.char-card:hover{transform:translateY(-6px);border-color:rgba(212,168,67,0.3);
  box-shadow:0 10px 35px rgba(0,0,0,0.7),0 0 40px rgba(212,168,67,0.08)}
.char-card.selected-left{border-color:rgba(74,143,212,0.5);box-shadow:0 0 20px rgba(74,143,212,0.2)}
.char-card.selected-left::before{background:linear-gradient(90deg,transparent,#4a8fd4 50%,transparent);opacity:1}
.char-card.selected-right{border-color:rgba(196,30,58,0.5);box-shadow:0 0 20px rgba(196,30,58,0.2)}
.char-card.selected-right::before{background:linear-gradient(90deg,transparent,#c41e3a 50%,transparent);opacity:1}
.char-card.selectable{cursor:pointer}
.char-card.selectable:active{transform:translateY(-2px) scale(0.98)}

.card-image-area{width:100%;height:280px;overflow:hidden;position:relative;background:linear-gradient(135deg,#1a1a22,#0e0e15)}
.card-image-area img{width:100%;height:100%;object-fit:cover;object-position:top center;
  transition:transform .5s,filter .3s;filter:brightness(0.85)}
.char-card:hover .card-image-area img{transform:scale(1.06);filter:brightness(1.0)}
.card-image-area::after{content:'';position:absolute;inset:0;
  background:linear-gradient(180deg,transparent 40%,rgba(14,14,21,0.95) 100%);pointer-events:none}
.card-placeholder{width:100%;height:100%;display:flex;align-items:center;justify-content:center;
  background:linear-gradient(135deg,#12121a,#0a0a10)}
.card-placeholder svg{width:80px;height:80px;opacity:0.15;fill:var(--gold)}

/* Badges */
.card-badge-style{position:absolute;top:10px;left:10px;font-family:'Oswald',sans-serif;font-size:9px;
  font-weight:600;letter-spacing:1.5px;text-transform:uppercase;padding:3px 8px;
  background:rgba(0,0,0,0.7);border-left:2px solid var(--gold);z-index:2;backdrop-filter:blur(4px)}
.card-badge-role{position:absolute;top:10px;right:10px;font-size:9px;font-weight:600;padding:3px 8px;
  background:rgba(0,0,0,0.7);border-radius:2px;z-index:2;backdrop-filter:blur(4px);letter-spacing:1px}
.card-badge-role.babyface{color:#8bc4f0;border:1px solid rgba(74,143,212,0.3)}
.card-badge-role.heel{color:#f08b9e;border:1px solid rgba(196,30,58,0.3)}
.card-badge-role.neutral{color:#b0b8c4;border:1px solid rgba(176,184,196,0.3)}

/* Corner label */
.corner-label{position:absolute;bottom:8px;left:50%;transform:translateX(-50%);font-family:'Oswald',sans-serif;
  font-size:10px;font-weight:700;letter-spacing:2px;text-transform:uppercase;padding:4px 14px;
  border-radius:2px;z-index:4;pointer-events:none}
.corner-label.blue{background:rgba(74,143,212,0.85);color:#fff}
.corner-label.red{background:rgba(196,30,58,0.85);color:#fff}

/* Card info */
.card-info{padding:12px 14px;display:flex;gap:10px;align-items:flex-start}
.card-text{flex:1;min-width:0}
.card-name{font-weight:900;font-size:17px;line-height:1.2;margin-bottom:2px}
.card-style-label{font-family:'Oswald',sans-serif;font-size:10px;letter-spacing:2px;
  text-transform:uppercase;color:var(--text-sub);margin-bottom:6px}
.card-mini-stats{display:flex;gap:8px;font-size:10px;color:var(--text-sub);flex-wrap:wrap}
.card-mini-stats .sv{color:var(--text-main);font-weight:700}
.card-overall{flex-shrink:0;width:56px;text-align:center;padding-top:2px}
.overall-num{font-family:'Bebas Neue',sans-serif;font-size:38px;line-height:1;
  background:linear-gradient(180deg,#fff 10%,var(--gold-light) 100%);
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;position:relative}
.overall-num::after{content:'';position:absolute;bottom:-2px;left:50%;transform:translateX(-50%);
  width:24px;height:1px;background:linear-gradient(90deg,transparent,var(--gold),transparent)}
.overall-label{font-family:'Oswald',sans-serif;font-size:7px;letter-spacing:3px;
  text-transform:uppercase;color:var(--gold);opacity:0.5;margin-top:5px}

/* ═══ CONFIRM MODAL ═══ */
.modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.92);backdrop-filter:blur(4px);
  z-index:200;align-items:center;justify-content:center;overflow-y:auto;padding:10px}
.modal-overlay.show{display:flex}
.modal-box{background:var(--card-bg);border:1px solid rgba(212,168,67,0.3);border-radius:4px;
  width:min(760px,95vw);max-height:min(90vh,900px);overflow-y:auto;position:relative;
  opacity:0;transform:translateY(40px);animation:modalIn .4s ease-out forwards;margin:auto}
@keyframes modalIn{to{opacity:1;transform:translateY(0)}}
.modal-grid{display:grid;grid-template-columns:220px 1fr;min-height:0}
.modal-image-section{position:relative;background:linear-gradient(135deg,#1a1a22,#0e0e15);overflow:hidden;max-height:420px}
.modal-image-section img{width:100%;height:100%;object-fit:cover;object-position:top center}
.modal-image-section::after{content:'';position:absolute;inset:0;
  background:linear-gradient(180deg,transparent 50%,rgba(14,14,21,0.3) 100%);pointer-events:none}
.modal-image-placeholder{width:100%;height:100%;display:flex;align-items:center;justify-content:center;
  background:linear-gradient(135deg,#12121a,#0a0a10)}
.modal-image-placeholder svg{width:80px;height:80px;opacity:0.15;fill:var(--gold)}
.modal-ov-badge{position:absolute;bottom:12px;left:12px;background:rgba(0,0,0,0.7);backdrop-filter:blur(6px);
  border:1px solid rgba(212,168,67,0.3);padding:6px 12px;text-align:center;z-index:2;border-radius:3px}
.modal-ov-num{font-family:'Bebas Neue',sans-serif;font-size:38px;line-height:1;
  background:linear-gradient(180deg,#fff 10%,var(--gold-light) 100%);
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.modal-ov-label{font-family:'Oswald',sans-serif;font-size:8px;letter-spacing:4px;
  text-transform:uppercase;color:var(--gold);opacity:0.6;margin-top:4px}
.modal-info-section{padding:20px;display:flex;flex-direction:column;gap:12px;overflow-y:auto}
.modal-corner-hint{font-family:'Oswald',sans-serif;font-size:10px;letter-spacing:3px;text-transform:uppercase}
.modal-corner-hint.blue{color:#4a8fd4}
.modal-corner-hint.red{color:#e85d75}
.modal-section-title{font-family:'Oswald',sans-serif;font-size:9px;letter-spacing:4px;
  text-transform:uppercase;color:var(--gold);opacity:0.7;margin-bottom:8px}
.modal-char-name{font-size:22px;font-weight:900;margin-bottom:4px}
.modal-tags{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:4px}
.modal-tag{font-family:'Oswald',sans-serif;font-size:10px;letter-spacing:1px;padding:3px 10px;
  border-radius:2px;font-weight:600}
.modal-tag.style-tag{background:rgba(212,168,67,0.12);border:1px solid rgba(212,168,67,0.25);color:var(--gold-light)}
.modal-tag.role-tag.babyface{background:rgba(74,143,212,0.15);color:#8bc4f0;border:1px solid rgba(74,143,212,0.3)}
.modal-tag.role-tag.heel{background:rgba(196,30,58,0.15);color:#f08b9e;border:1px solid rgba(196,30,58,0.3)}
.modal-tag.role-tag.neutral{background:rgba(176,184,196,0.15);color:#b0b8c4;border:1px solid rgba(176,184,196,0.3)}
.modal-data-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.modal-data-item .md-label{font-size:11px;color:rgba(255,255,255,0.4)}
.modal-data-item .md-value{font-size:11px;font-weight:700}
.modal-section-border{border-bottom:1px solid rgba(255,255,255,0.05);padding-bottom:10px}
.modal-ab-row{display:flex;align-items:center;gap:8px;margin-bottom:6px}
.modal-ab-name{font-family:'Oswald',sans-serif;font-size:10px;letter-spacing:1px;color:var(--text-sub);min-width:72px;text-transform:uppercase}
.modal-ab-track{flex:1;height:8px;background:rgba(255,255,255,0.06);border-radius:3px;overflow:hidden}
.modal-ab-fill{height:100%;border-radius:3px;width:0;transition:width .8s ease-out;
  background:linear-gradient(90deg,#2a9d8f,#5dd9ca)}
.modal-ab-val{font-family:'Oswald',sans-serif;font-size:12px;font-weight:700;min-width:28px;text-align:right}
.modal-profile-section{display:flex;flex-direction:column;gap:6px}
.modal-profile-item .mp-label{font-size:9px;color:rgba(255,255,255,0.4);font-weight:400;margin-bottom:1px}
.modal-profile-item .mp-text{font-size:11px;color:rgba(255,255,255,0.8);line-height:1.5}
.modal-lockin-wrap{padding:14px;text-align:center}
.btn-lockin{font-family:'Bebas Neue',sans-serif;font-size:22px;letter-spacing:4px;padding:0;
  width:min(400px,80%);height:52px;border:none;border-radius:4px;cursor:pointer;
  background:linear-gradient(135deg,#d4a843,#f0d078,#d4a843);color:#0e0e15;transition:all .2s}
.btn-lockin:hover{filter:brightness(1.15);box-shadow:0 0 20px rgba(212,168,67,0.4)}
.btn-lockin:active{transform:scale(0.96)}
.modal-close{position:absolute;top:16px;right:16px;width:40px;height:40px;
  background:rgba(0,0,0,0.6);border:1px solid rgba(255,255,255,0.2);border-radius:3px;
  cursor:pointer;font-size:24px;color:rgba(255,255,255,0.6);display:flex;align-items:center;
  justify-content:center;z-index:10;transition:all .2s;line-height:1}
.modal-close:hover{background:var(--red);border-color:var(--red);color:#fff}
/* Modal: image click hint */
.modal-image-section.clickable{cursor:pointer}
.modal-image-section.clickable::before{content:'TAP TO SELECT';position:absolute;top:50%;left:50%;
  transform:translate(-50%,-50%);font-family:'Bebas Neue',sans-serif;font-size:20px;letter-spacing:6px;
  color:rgba(212,168,67,0);z-index:3;transition:color .3s;pointer-events:none;
  text-shadow:0 2px 8px rgba(0,0,0,0.8)}
.modal-image-section.clickable:hover::before{color:rgba(212,168,67,0.9)}
.modal-image-section.clickable:hover img{filter:brightness(1.1)}
/* Modal responsive: narrow screens */
@media(max-width:600px){
  .modal-grid{grid-template-columns:1fr;min-height:auto}
  .modal-image-section{max-height:200px}
  .modal-info-section{padding:14px}
  .modal-char-name{font-size:20px}
  .modal-ov-badge{bottom:8px;left:8px;padding:4px 10px}
  .modal-ov-num{font-size:28px}
  .modal-lockin-wrap{padding:10px}
  .btn-lockin{height:42px;font-size:17px}
}
/* Modal responsive: short screens */
@media(max-height:700px){
  .modal-grid{min-height:auto}
  .modal-image-section{max-height:200px}
  .modal-info-section{padding:14px;gap:8px}
  .modal-profile-item .mp-text{font-size:10px;line-height:1.3}
}

/* ═══ MATCH SCREEN ═══ */
.match-grid{display:grid;grid-template-columns:1.2fr 1fr 1.2fr;gap:10px;margin-bottom:10px}

.fighter-panel{background:var(--card-bg);border:1px solid rgba(255,255,255,0.08);border-radius:4px;
  overflow:hidden;transition:border-color .15s,box-shadow .15s;position:relative}
.fighter-panel.left{border-color:rgba(74,143,212,0.2)}
.fighter-panel.right{border-color:rgba(196,30,58,0.2)}
.fighter-panel.flash-atk{border-color:rgba(255,255,255,0.6);box-shadow:0 0 18px rgba(255,255,255,0.15)}
.fighter-panel.flash-hit{border-color:rgba(255,60,60,0.6) !important}

/* HP-linked panel states */
.fighter-panel.exhausted .portrait-area img{filter:brightness(0.82) saturate(0.85)}
.fighter-panel.critical .portrait-area img{filter:brightness(0.7) saturate(0.6)}
@keyframes damagePulse{
  0%{box-shadow:0 0 15px rgba(196,30,58,0.3)}
  50%{box-shadow:0 0 5px rgba(196,30,58,0.08)}
  100%{box-shadow:0 0 15px rgba(196,30,58,0.3)}
}
.fighter-panel.critical{animation:damagePulse 1.5s ease-in-out infinite;border-color:rgba(196,30,58,0.3)}

/* DANGER overlay */
.danger-overlay{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%) scale(2);
  font-family:'Bebas Neue',sans-serif;font-size:28px;letter-spacing:6px;color:rgba(196,30,58,0.9);
  z-index:10;pointer-events:none;opacity:0}
@keyframes dangerPop{0%{transform:translate(-50%,-50%) scale(2);opacity:0}
  20%{transform:translate(-50%,-50%) scale(1);opacity:1}
  80%{opacity:1}100%{transform:translate(-50%,-50%) scale(1);opacity:0}}
.danger-overlay.show{animation:dangerPop 1.2s ease-out forwards}

/* Portrait */
.portrait-area{width:100%;height:min(960px,62vh);overflow:hidden;position:relative;background:linear-gradient(135deg,#1a1a22,#0e0e15)}
.portrait-area img{width:100%;height:100%;object-fit:cover;object-position:top center;filter:brightness(0.9);transition:filter .3s}
.fighter-panel.left .portrait-area img{transform:scaleX(-1)}
.portrait-area::after{content:'';position:absolute;inset:0;
  background:linear-gradient(180deg,transparent 50%,rgba(14,14,21,0.9) 100%);pointer-events:none}
.portrait-placeholder{width:100%;height:100%;display:flex;flex-direction:column;
  align-items:center;justify-content:center;gap:8px}
.portrait-placeholder svg{width:60px;height:60px;opacity:0.12;fill:var(--gold)}
.portrait-placeholder span{font-size:11px;color:var(--text-dim)}

/* Shake 3-tier */
@keyframes shakeS{0%{transform:translateX(0)}25%{transform:translateX(-5px)}50%{transform:translateX(5px)}75%{transform:translateX(-3px)}100%{transform:translateX(0)}}
@keyframes shakeM{0%{transform:translateX(0)}20%{transform:translateX(-8px)}40%{transform:translateX(8px)}60%{transform:translateX(-6px)}80%{transform:translateX(4px)}100%{transform:translateX(0)}}
@keyframes shakeL{0%{transform:translateX(0) scale(1)}15%{transform:translateX(-12px) scale(1.03)}30%{transform:translateX(12px) scale(1)}45%{transform:translateX(-10px)}60%{transform:translateX(8px)}80%{transform:translateX(-4px)}100%{transform:translateX(0) scale(1)}}
@keyframes shakeSFlip{0%{transform:scaleX(-1) translateX(0)}25%{transform:scaleX(-1) translateX(-5px)}50%{transform:scaleX(-1) translateX(5px)}75%{transform:scaleX(-1) translateX(-3px)}100%{transform:scaleX(-1) translateX(0)}}
@keyframes shakeMFlip{0%{transform:scaleX(-1) translateX(0)}20%{transform:scaleX(-1) translateX(-8px)}40%{transform:scaleX(-1) translateX(8px)}60%{transform:scaleX(-1) translateX(-6px)}80%{transform:scaleX(-1) translateX(4px)}100%{transform:scaleX(-1) translateX(0)}}
@keyframes shakeLFlip{0%{transform:scaleX(-1) translateX(0) scale(1)}15%{transform:scaleX(-1) translateX(-12px) scale(1.03)}30%{transform:scaleX(-1) translateX(12px) scale(1)}45%{transform:scaleX(-1) translateX(-10px)}60%{transform:scaleX(-1) translateX(8px)}80%{transform:scaleX(-1) translateX(-4px)}100%{transform:scaleX(-1) translateX(0) scale(1)}}
.shake-s{animation:shakeS .2s linear}
.shake-m{animation:shakeM .3s linear}
.shake-l{animation:shakeL .4s linear}
.shake-s-flip{animation:shakeSFlip .2s linear}
.shake-m-flip{animation:shakeMFlip .3s linear}
.shake-l-flip{animation:shakeLFlip .4s linear}

/* Screen shake */
@keyframes screenShake{0%{transform:translateX(0)}25%{transform:translateX(-2px)}50%{transform:translateX(2px)}75%{transform:translateX(-1px)}100%{transform:translateX(0)}}
.screen-shake{animation:screenShake .2s linear}

/* HP flash */
@keyframes hpFlash{0%{background:rgba(255,255,255,0.4)}100%{background:rgba(255,255,255,0)}}
.hp-flash .hp-bar{animation:hpFlash .1s ease-out}

/* Speech Bubble */
.speech-bubble{position:absolute;bottom:28px;left:50%;transform:translateX(-50%);
  background:rgba(0,0,0,0.82);border-radius:4px;padding:6px 14px;font-size:16px;font-weight:700;
  white-space:nowrap;z-index:5;opacity:0;transition:opacity .2s;pointer-events:none;
  border:1px solid rgba(255,255,255,0.15)}
.speech-bubble.visible{opacity:1}
.speech-bubble.t-atk{color:var(--gold-light)}
.speech-bubble.t-def{color:#f08b9e}

/* Fighter info */
.fighter-info{padding:14px 16px}
.f-name-row{display:flex;justify-content:space-between;align-items:baseline;margin-bottom:2px}
.f-name{font-weight:900;font-size:18px}
.f-role-tag{font-size:9px;font-weight:600;padding:2px 6px;border-radius:2px;letter-spacing:.5px}
.f-role-tag.babyface{background:rgba(74,143,212,0.15);color:#8bc4f0}
.f-role-tag.heel{background:rgba(196,30,58,0.15);color:#f08b9e}
.f-role-tag.neutral{background:rgba(176,184,196,0.15);color:#b0b8c4}
.f-style{font-family:'Oswald',sans-serif;font-size:10px;letter-spacing:2px;
  text-transform:uppercase;color:var(--gold);opacity:0.6;margin-bottom:10px}

/* HP */
.hp-section{margin-bottom:12px}
.hp-header{display:flex;justify-content:space-between;font-size:11px;margin-bottom:4px}
.hp-label{font-family:'Oswald',sans-serif;letter-spacing:2px;color:var(--text-sub)}
.hp-value{font-weight:700;font-size:14px;transition:color .3s}
.hp-bar{height:18px;background:#1a2538;border-radius:3px;overflow:hidden;transition:box-shadow .3s}
.hp-fill{height:100%;border-radius:3px;transition:width .6s ease}
.hp-fill.high{background:linear-gradient(90deg,#46f09f,#a8f56b)}
.hp-fill.mid{background:linear-gradient(90deg,#f0c846,#f09846)}
.hp-fill.low{background:linear-gradient(90deg,#f04646,#f07846)}
.hp-bar.exhausted-glow{box-shadow:inset 0 0 4px rgba(240,200,70,0.3)}

/* Ability bars */
.ability-bars{display:flex;flex-direction:column;gap:7px}
.ab-row{display:flex;align-items:center;gap:8px}
.ab-name{font-family:'Oswald',sans-serif;font-size:10px;letter-spacing:1px;color:var(--text-sub);min-width:52px;text-transform:uppercase}
.ab-track{flex:1;height:12px;background:rgba(255,255,255,0.06);border-radius:3px;overflow:hidden}
.ab-fill{height:100%;border-radius:3px;background:linear-gradient(90deg,#2a9d8f,#5dd9ca)}
.ab-val{font-family:'Oswald',sans-serif;font-size:13px;font-weight:700;min-width:24px;text-align:right}

/* ═══ CENTER PANEL ═══ */
.center-panel{background:var(--card-bg);border:1px solid rgba(212,168,67,0.15);
  border-radius:4px;padding:16px;display:flex;flex-direction:column;overflow-y:auto}
.top-line{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
.turn-label{font-family:'Oswald',sans-serif;font-size:16px;font-weight:700;letter-spacing:2px}
.phase-pill{font-family:'Oswald',sans-serif;font-size:11px;letter-spacing:2px;text-transform:uppercase;
  padding:4px 12px;background:rgba(212,168,67,0.12);border:1px solid rgba(212,168,67,0.25);
  border-radius:2px;color:var(--gold-light);transition:all .3s}
.phase-pill.flash{background:rgba(212,168,67,0.35);box-shadow:0 0 12px rgba(212,168,67,0.3)}

/* Narration */
.narration-box{border:1px solid rgba(212,168,67,0.3);background:rgba(0,0,0,0.4);border-radius:3px;
  padding:18px 20px;min-height:80px;margin-bottom:12px;display:flex;flex-direction:column;justify-content:center}
.nar-line{line-height:1.7;opacity:0;transform:translateY(-5px);transition:opacity .3s,transform .3s}
.nar-line.show{opacity:1;transform:translateY(0)}
.nar-main{font-size:18px;font-weight:700;color:#fff}
.nar-dmg{font-size:16px;color:var(--gold-light);font-weight:700;margin-top:3px}
.nar-react{font-size:14px;color:var(--text-sub);margin-top:4px}
.nar-finish{font-size:17px;color:var(--gold-light);font-weight:700}
.nar-empty{font-size:14px;color:var(--text-dim);text-align:center}

/* Move display */
.move-box{text-align:center;border:1px solid rgba(255,255,255,0.06);border-radius:3px;
  padding:10px;background:rgba(0,0,0,0.2);margin-bottom:12px}
.move-label{font-family:'Oswald',sans-serif;font-size:8px;letter-spacing:3px;color:var(--text-dim);
  text-transform:uppercase;margin-bottom:5px}
.move-value{font-weight:800;font-size:26px;color:var(--gold-light);min-height:32px}
@keyframes movePop{0%{transform:scale(0.7);opacity:0}100%{transform:scale(1);opacity:1}}
.move-pop{animation:movePop .3s ease-out}

/* Momentum */
.momentum-section{margin-bottom:12px}
.momentum-header{font-family:'Oswald',sans-serif;font-size:8px;letter-spacing:3px;color:var(--text-dim);
  text-transform:uppercase;margin-bottom:5px}
.momentum-bar{height:18px;border-radius:3px;overflow:hidden;border:1px solid rgba(255,255,255,0.1);
  display:flex;background:rgba(0,0,0,0.3)}
.m-left{background:linear-gradient(90deg,#1a3a6b,#4a8fd4);transition:width .6s}
.m-right{background:linear-gradient(90deg,#c41e3a,#e85d75);transition:width .6s}
.momentum-names{margin-top:4px;font-size:10px;display:flex;justify-content:space-between;color:var(--text-sub)}

/* Log */
.log-section{flex:1;min-height:0}
.log-header{font-family:'Oswald',sans-serif;font-size:8px;letter-spacing:3px;color:var(--text-dim);
  text-transform:uppercase;margin-bottom:5px}
.log-box{flex:1;min-height:120px;max-height:none;overflow-y:auto;border:1px solid rgba(255,255,255,0.05);border-radius:3px;
  background:rgba(0,0,0,0.2);padding:8px 10px;font-size:12px;line-height:1.6}
.log-entry{margin-bottom:4px;color:var(--text-sub)}
.log-entry.finish{color:var(--gold-light);font-weight:700}
.log-entry.system{color:rgba(212,168,67,0.7);font-style:italic}

/* Next turn btn — fixed bottom bar */
.action-bar{position:fixed;bottom:0;left:0;right:0;z-index:30;text-align:center;padding:10px 20px 14px;
  background:linear-gradient(180deg,transparent 0%,rgba(10,10,16,0.95) 30%,rgba(10,10,16,0.98) 100%);
  backdrop-filter:blur(6px)}
.action-bar-spacer{height:70px}
.btn-next{font-family:'Oswald',sans-serif;font-size:18px;font-weight:700;letter-spacing:4px;
  text-transform:uppercase;padding:14px 0;width:min(700px,100%);border:1px solid var(--gold-dim);
  border-radius:3px;cursor:pointer;background:linear-gradient(135deg,rgba(212,168,67,0.15),rgba(212,168,67,0.05));
  color:var(--gold-light);transition:all .2s}
.btn-next:hover:not(:disabled){background:linear-gradient(135deg,rgba(212,168,67,0.25),rgba(212,168,67,0.1));
  box-shadow:0 0 20px rgba(212,168,67,0.15);transform:translateY(-1px)}
.btn-next:disabled{opacity:0.35;cursor:not-allowed}
@keyframes btnPulse{0%{box-shadow:0 0 5px rgba(212,168,67,0.1)}50%{box-shadow:0 0 20px rgba(212,168,67,0.25)}100%{box-shadow:0 0 5px rgba(212,168,67,0.1)}}

/* Kickout white flash */
@keyframes kickoutFlash{0%{box-shadow:0 0 30px rgba(255,255,255,0.6),inset 0 0 20px rgba(255,255,255,0.3)}
  100%{box-shadow:none}}
.fighter-panel.kickout-flash{animation:kickoutFlash .6s ease-out}

/* Climax gold aura (fire scene) */
@keyframes goldAura{0%{box-shadow:0 0 40px rgba(212,168,67,0.6),inset 0 0 30px rgba(212,168,67,0.3)}
  50%{box-shadow:0 0 60px rgba(240,208,120,0.5),inset 0 0 40px rgba(240,208,120,0.2)}
  100%{box-shadow:none}}
.fighter-panel.gold-aura{animation:goldAura 1.5s ease-out}

/* Finish flash */
.finish-flash{position:fixed;inset:0;background:rgba(255,255,255,0.15);z-index:50;pointer-events:none;
  animation:flashAnim .3s ease-out forwards}
@keyframes flashAnim{0%{opacity:1}100%{opacity:0}}

/* ═══ RESULT OVERLAY ═══ */
.result-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0);
  backdrop-filter:blur(0px);z-index:100;flex-direction:column;align-items:center;justify-content:center;
  transition:background .6s ease,backdrop-filter .6s ease}
.result-overlay.show{display:flex}
.result-overlay.visible{background:rgba(0,0,0,0.85);backdrop-filter:blur(4px)}
.result-box{background:var(--card-bg);border:2px solid rgba(212,168,67,0.5);border-radius:4px;
  padding:32px;text-align:center;box-shadow:0 0 40px rgba(212,168,67,0.15);
  width:min(640px,90vw);opacity:0;transform:scale(0.9);transition:opacity .4s ease-out,transform .4s ease-out}
.result-box.visible{opacity:1;transform:scale(1)}
.result-content{display:flex;gap:24px;align-items:center;margin-bottom:20px;text-align:left}
.result-image{flex-shrink:0;width:160px;height:200px;border-radius:4px;overflow:hidden;
  border:2px solid var(--gold-dim);opacity:0;transition:opacity .4s}
.result-image.visible{opacity:1}
.result-image img{width:100%;height:100%;object-fit:cover;object-position:top center}
.result-image-placeholder{width:100%;height:100%;display:flex;align-items:center;justify-content:center;
  background:linear-gradient(135deg,#12121a,#0a0a10)}
.result-image-placeholder svg{width:50px;height:50px;opacity:0.15;fill:var(--gold)}
.result-text{flex:1}
.result-winner{font-family:'Bebas Neue',sans-serif;font-size:48px;letter-spacing:6px;
  background:linear-gradient(180deg,#fff 20%,var(--gold-light) 100%);
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;
  margin-bottom:4px;line-height:1.1;opacity:0;transition:opacity .4s}
.result-winner.visible{opacity:1}
.result-winner::after{content:'';display:block;width:60px;height:1px;
  background:linear-gradient(90deg,var(--gold),transparent);margin-top:6px}
.result-type{font-family:'Oswald',sans-serif;font-size:16px;font-weight:600;letter-spacing:3px;
  color:var(--gold);margin-bottom:16px;opacity:0;transition:opacity .4s}
.result-type.visible{opacity:1}
.result-quote{background:rgba(255,255,255,0.06);border-left:3px solid var(--gold-dim);
  padding:12px 16px;font-size:16px;font-weight:700;color:#fff;min-height:44px;
  opacity:0;transition:opacity .4s}
.result-quote.visible{opacity:1}
.result-draw-content{text-align:center;margin-bottom:20px}
.btn-end{font-family:'Oswald',sans-serif;font-size:14px;letter-spacing:3px;text-transform:uppercase;
  padding:12px 48px;border:1px solid var(--gold-dim);border-radius:3px;cursor:pointer;
  background:rgba(212,168,67,0.1);color:var(--gold-light);transition:all .2s;
  opacity:0;transition:opacity .4s,background .2s,color .2s}
.btn-end.visible{opacity:1}
.btn-end:hover{background:var(--gold);color:var(--bg-dark);font-weight:700}

/* ═══ FINISH CLICK SYSTEM (v3.5) ═══ */
.finish-click-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.3);z-index:40;pointer-events:none;
  opacity:0;transition:opacity .3s}
.finish-click-overlay.show{opacity:1;pointer-events:auto}
.finish-click-overlay::before{content:'';position:absolute;inset:0;
  background:radial-gradient(ellipse 60% 50% at 50% 50%,transparent 40%,rgba(0,0,0,0.4) 100%);pointer-events:none}
.finish-click-btn{position:fixed;left:50%;bottom:90px;transform:translateX(-50%) scale(0.8);
  font-family:'Bebas Neue',sans-serif;font-size:28px;letter-spacing:4px;
  color:#fff;padding:16px 48px;border:2px solid rgba(212,168,67,0.8);border-radius:8px;
  background:linear-gradient(135deg,#8b0000,#d4a843);cursor:pointer;z-index:45;
  box-shadow:0 0 20px rgba(212,168,67,0.4),0 0 60px rgba(139,0,0,0.3);
  opacity:0;transition:opacity .3s ease-out,transform .3s ease-out}
.finish-click-btn.show{opacity:1;transform:translateX(-50%) scale(1);
  animation:finishPulse 1.2s ease-in-out infinite}
.finish-click-btn:hover{filter:brightness(1.2)}
.finish-click-btn:disabled{pointer-events:none;filter:brightness(0.7)}
@keyframes finishPulse{
  0%{transform:translateX(-50%) scale(1);box-shadow:0 0 20px rgba(212,168,67,0.4),0 0 60px rgba(139,0,0,0.3)}
  50%{transform:translateX(-50%) scale(1.05);box-shadow:0 0 40px rgba(212,168,67,0.7),0 0 80px rgba(139,0,0,0.5)}
  100%{transform:translateX(-50%) scale(1);box-shadow:0 0 20px rgba(212,168,67,0.4),0 0 60px rgba(139,0,0,0.3)}}
/* Finish count text overlay */
.finish-count-text{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%) scale(2);
  font-family:'Bebas Neue',sans-serif;font-size:72px;letter-spacing:8px;z-index:42;
  pointer-events:none;opacity:0;text-shadow:0 0 30px rgba(212,168,67,0.8)}
.finish-count-text.gold{color:var(--gold-light)}
.finish-count-text.red-gold{color:#ff6b4a}
.finish-count-text.white{color:#fff}
@keyframes countPop{0%{transform:translate(-50%,-50%) scale(2);opacity:0}
  15%{transform:translate(-50%,-50%) scale(1);opacity:1}
  70%{opacity:1}100%{transform:translate(-50%,-50%) scale(0.9);opacity:0}}
.finish-count-text.show{animation:countPop 0.8s ease-out forwards}
</style>
</head>
<body>
<div class="app">
  <header class="site-header">
    <h1 class="site-title">CHARACTER SELECT</h1>
    <p class="site-subtitle" id="headerSub">学園女子プロレス — 対戦カード選択</p>
  </header>
  <div id="screenContainer"></div>
  <div class="result-overlay" id="resultOverlay"></div>
  <div class="modal-overlay" id="modalOverlay"></div>
  <div class="finish-click-overlay" id="finishOverlay"></div>
  <div class="finish-click-btn" id="finishBtn"></div>
</div>
<script>
// ═══════════════════════════════════
// DATA
// ═══════════════════════════════════
const C = [
  {id:1, name:'高津小春',    h:161,pw:73,sp:75,te:47,st:79,mn:91,style:'Striker',   role:'Neutral',
   vl:["ふふっ、まだまだ強くなれる！","剣の道も、リングの道も…負けないよ！","この勝利、次の強敵への一歩だから！"],
   profile:{personality:'負けず嫌いの自信家。剣道で培った精神力と集中力で常に冷静に試合を支配する。口は悪くないが、心の中では常に「自分が一番」と思っている',
     background:'剣道部の元エース。その打撃センスと精神力に強みがある。どこか不器用で勝ち星が伸びない',
     specialty:'延髄斬りやチョップなどの打撃が得意。剣道由来の踏み込みと間合い管理が武器',
     weakness:'グラウンドに持ち込まれると対応力が落ちる。関節技の防御経験が浅い'}},
  {id:2, name:'澤出みずき',  h:158,pw:73,sp:78,te:73,st:73,mn:72,style:'Allround',  role:'Babyface',
   vl:["やった…！ 頑張ってよかった…！","ふぅ…いい試合だったね","応援してくれた人、ありがとう…！"],
   profile:{personality:'穏やかで癒し系の雰囲気だが、リングに上がると芯の強さを見せる実力者。誰にでも優しく、対戦相手にも敬意を忘れない',
     background:'才能に恵まれた隠れた実力者。バランスの良いオールラウンドなスタイルで安定した強さを見せる',
     specialty:'状況に応じた柔軟な技選択。投げと打撃のバランスが良く、どんな相手にも合わせられる',
     weakness:'優しすぎる性格が仇となり、追い込み時に攻めきれないことがある'}},
  {id:3, name:'富岡加奈子',  h:168,pw:90,sp:68,te:70,st:76,mn:83,style:'Grappler',  role:'Neutral',
   vl:["この力…もう誰にも負けない","富岡の名に懸けて、勝利を掴むわ","ようやく…本当の私を見せられた"],
   profile:{personality:'財閥令嬢としてのプライドと、虚弱さを努力で克服した強い意志を持つ。寡黙だが、内に秘めた闘志は誰よりも熱い',
     background:'富岡財閥の一人娘。虚弱だった幼少期に一念発起。「誰にも恥ずかしくない自分になる」と誓い、体を鍛え上げた。長身と鍛え抜かれた体躯を活かしたパワーファイトが持ち味',
     specialty:'パワーボム、ジャーマンスープレックスなどの大型投げ技。恵まれた体格を活かした力押し',
     weakness:'スピード勝負になると後手に回りがち。身長差を利用した飛び技に弱い'}},
  {id:4, name:'副沢たまき',  h:161,pw:71,sp:68,te:74,st:68,mn:68,style:'Technique', role:'Neutral',
   vl:["あー勝った勝った。疲れたー","ま、こんなもんでしょ","楽勝…ってわけでもなかったけどね"],
   profile:{personality:'脱力系でマイペース。常に省エネで楽をしたがるが、いざとなるとキレのある技術を見せる天才肌。確かな地力と自信を感じさせる',
     background:'八百屋の娘。本人は「別にプロレスが好きってわけじゃないけど」と言いつつ、技術的なセンスは学園トップクラス',
     specialty:'テクニカルな丸め込み、カウンター技。最小限の動きで相手を制する省エネファイト',
     weakness:'スタミナ・モチベーションの波が大きい。長期戦になると集中力が切れる'}},
  {id:5, name:'深町真琴',    h:160,pw:58,sp:91,te:62,st:85,mn:63,style:'Speed',     role:'Babyface',
   vl:["まだまだ…もっと速く、もっと強く！","この脚がある限り、走り続けるよ","勝った…！ トレーニングの成果だね"],
   profile:{personality:'ストイックで真面目な努力家。陸上部で培った脚力と持久力をプロレスにも全力投入。明るく快活なスポーツ少女',
     background:'陸上部短距離のエース。100m走で国内上位の実力を持つ。プロレスでもその圧倒的なスピードを武器に、誰も追いつけない速攻スタイルを確立',
     specialty:'飛び技、ドロップキック、高速タックル。スピードを活かした連続攻撃で相手を翻弄',
     weakness:'パワー不足が顕著。力負けする展開になると打開策が限られる'}},
  {id:6, name:'橘玲美',      h:171,pw:71,sp:73,te:91,st:75,mn:74,style:'Submission',role:'Heel',
   vl:["…もう少し、もがいてほしかったわね","その悲鳴…悪くなかったわよ？","…ふふ"],
   profile:{personality:'寡黙で冷徹。関節技で相手が苦しむ姿に密かな愉悦を感じる嗜虐的な一面を持つ。普段は物静かで何を考えているかわからない',
     background:'中学生時は全くの無名だが、関節技の技術は市内随一と言われる。長身を活かしたリーチの長い関節技で、逃げ場のない地獄を作り出す',
     specialty:'腕菱木十字固め、三角締め、各種関節技。一度捕まえたら離さない蛇のような関節地獄',
     weakness:'スタンドでの打ち合いはやや苦手。距離を取られると持ち味が出せない'}},
  {id:7, name:'生駒エリカ',  h:153,pw:78,sp:71,te:55,st:82,mn:82,style:'Brawler',   role:'Heel',
   vl:["アタシの勝ちだ！ 文句あんのかよ？","っへ！　楽勝ってヤツ？","ハッ！ こんなもんか？こっちはまだやれんぞ！"],
   profile:{personality:'豪快で乱暴。帰国子女で実はいいところの出だが、素行は悪い。小さいながらも豪放磊落。身近な仲間には慕われている。',
     background:'幼少期をアメリカで過ごし、現地でストリートファイトに明け暮れた。帰国後、そのケンカスタイルをプロレスに持ち込み、ルール無用の荒っぽいファイトで観客を沸かせる',
     specialty:'ラリアット、頭突き、噛みつき（反則スレスレ）。パワーとガッツの荒削りファイト',
     weakness:'技術的な攻防が苦手。テクニシャンの丸め込みに弱い'}},
  {id:8, name:'川野辺菜穂子',h:168,pw:66,sp:80,te:69,st:71,mn:76,style:'Technique', role:'Babyface',
   vl:["ふう…諦めなくてよかった","良い試合でした。ありがとう","この勝利…ゆみえにも報告しなきゃ"],
   profile:{personality:'穏やかで上品だが、芯は頑固。ピアニストとしての繊細な指先と、決して折れない精神力を兼ね備える。礼儀正しく対戦相手にも敬意を払う',
     background:'幼少期からピアノを習い、音大進学も視野に入れている。プロレスでは、繊細な技術と冷静な試合運びで玄人好みの試合を展開',
     specialty:'テクニカルな切り返し、連携技。冷静な状況判断からの的確な技選択',
     weakness:'爆発力に欠ける。一発逆転の大技がやや少ない'}},
  {id:9, name:'岸ゆみえ',    h:155,pw:48,sp:53,te:78,st:64,mn:78,style:'Technique', role:'Babyface',
   vl:["はぁ…　はぁ…　か、勝てた…","舐めてると足元すくわれるってこと","菜穂子、見てたかな…？"],
   profile:{personality:'メガネの優等生。冷めた性格であまり感情は出さないが、試合中に思わぬ底力を見せることがある',
     background:'試合前に集めた情報をもとに戦略を立てる理論家。意外にも関節技のセンスが開花。まだ発展途上だが伸びしろ有り',
     specialty:'丸め込み技、小さい体を活かしたスクールボーイ系。番狂わせを起こす「隠れた実力者」',
     weakness:'ステータスは全体的に低い。パワーファイターには力負けしやすい'}},
  {id:10,name:'大河内紗代子',h:164,pw:93,sp:76,te:66,st:69,mn:77,style:'Grappler',  role:'Heel',
   vl:["当然の結果。大河内に敵はいない","カスは地べたに這うのがお似合いね…","…退屈な試合だったわね"],
   profile:{personality:'名門大河内家の絶対的な支配者。圧倒的なパワーと高慢な態度で対戦相手を見下す。負けることを一切想定していない王者の風格',
     background:'大河内家の次期当主候補。幼少期から英才教育を受け、その一環として始めた格闘訓練でずば抜けた才能を見せる。学園最強の名をほしいままにする絶対女王',
     specialty:'パワーボム、ラリアット、各種パワー技。圧倒的な力で相手をねじ伏せる王道スタイル',
     weakness:'スピードタイプとの相性がやや悪い。プライドの高さが油断を生むことも'}},
  {id:11,name:'四条あずさ',  h:163,pw:64,sp:68,te:62,st:67,mn:62,style:'Allround',  role:'Heel',
   vl:["紗代子さまに勝利を捧げます！","ふふ、私だってやれるんですから！","紗代子さまが見ていてくださったら…"],
   profile:{personality:'表向きはお嬢様だが、大河内紗代子への盲目的な信奉者。紗代子のためなら手段を選ばず、ダーティな戦法も厭わない。甘えた口調の裏に計算高さが潜む',
     background:'四条家は大河内家の傘下にある家柄。幼い頃から紗代子に憧れ、その付き人として行動を共にしてきた。プロレスも紗代子に認められるために始めたが、意外と器用でオールラウンドに戦える',
     specialty:'反則技スレスレのダーティファイト、急所攻撃、目つぶし。ルールの隙を突く狡猾さ',
     weakness:'正面からのガチンコ勝負には弱い。メンタルが不安定で動揺しやすい'}}
];

const commonMoves=[
{n:'ストンピング',d:2,c:'strike'},{n:'ボディパンチ',d:3,c:'strike'},{n:'バックエルボー',d:3,c:'strike'},
{n:'ナックルパンチ',d:3,c:'strike'},{n:'逆水平チョップ',d:4,c:'strike'},{n:'エルボー・スタンプ',d:5,c:'strike'},
{n:'マシンガン・チョップ',d:5,c:'strike'},{n:'ニーキック',d:6,c:'strike'},{n:'ヘッドバット',d:6,c:'strike'},
{n:'ビッグブーツ',d:7,c:'strike'},{n:'低空ドロップキック',d:7,c:'strike'},{n:'サッカーボールキック',d:7,c:'strike'},
{n:'ドロップキック',d:8,c:'strike'},{n:'ジャンピング・エルボー',d:8,c:'strike'},{n:'ローリング・エルボー',d:9,c:'strike'},
{n:'延髄斬り',d:9,c:'strike'},{n:'ミサイルキック',d:9,c:'strike'},{n:'ラリアット',d:10,c:'strike'},
{n:'スーパーキック',d:10,c:'strike'},{n:'クローズライン',d:10,c:'strike'},
{n:'ロックアップからの押し込み',d:2,c:'throw'},{n:'ショルダータックル',d:3,c:'throw'},
{n:'ヒップトス',d:3,c:'throw'},{n:'アームドラッグ',d:3,c:'throw'},{n:'ヘッドロック・テイクダウン',d:3,c:'throw'},
{n:'ファイヤーマンズキャリー',d:4,c:'throw'},{n:'ボディスラム',d:6,c:'throw'},{n:'スープレックス',d:7,c:'throw'},
{n:'スナップ・スープレックス',d:7,c:'throw'},{n:'ブレーンバスター',d:8,c:'throw'},
{n:'サイド・スープレックス',d:8,c:'throw'},{n:'ネックブリーカー',d:8,c:'throw'},
{n:'ボディスラム',d:8,c:'throw'},{n:'スウィンギング・ネックブリーカー',d:8,c:'throw'},
{n:'バックブリーカー',d:8,c:'throw'},{n:'サモアン・ドロップ',d:9,c:'throw'},
{n:'ベリー・トゥ・ベリー',d:9,c:'throw'},{n:'タイガー・ドライバー',d:9,c:'throw'},
{n:'スパインバスター',d:9,c:'throw'},{n:'DDT',d:10,c:'throw'},
{n:'チンロック',d:2,c:'submission'},{n:'ネックロック',d:2,c:'submission'},{n:'ヘッドロック',d:3,c:'submission'},
{n:'リストロック',d:4,c:'submission'},{n:'ハンマーロック',d:4,c:'submission'},{n:'アームリンガー',d:4,c:'submission'},
{n:'スリーパー・ホールド',d:6,c:'submission'},{n:'フルネルソン',d:6,c:'submission'},
{n:'コブラツイスト',d:7,c:'submission'},{n:'ベアハッグ',d:7,c:'submission'},
{n:'キャメルクラッチ',d:7,c:'submission'},{n:'インディアン・デスロック',d:7,c:'submission'},
{n:'ボストンクラブ',d:8,c:'submission'},{n:'アキレス腱固め',d:9,c:'submission'},
{n:'フライング・クロスボディ',d:7,c:'aerial'},{n:'ダイビング・ボディ・プレス',d:8,c:'aerial'},
{n:'セントーン',d:7,c:'aerial'},{n:'トペ・スイシーダ',d:9,c:'aerial'},
{n:'プランチャ・スイシーダ',d:8,c:'aerial'},{n:'ダイビング・エルボー',d:8,c:'aerial'},
{n:'ダイビング・ヘッドバット',d:7,c:'aerial'},{n:'ミサイルキック（飛）',d:9,c:'aerial'},
{n:'エルボードロップ',d:3,c:'ground'},{n:'ニードロップ',d:4,c:'ground'},{n:'レッグドロップ',d:4,c:'ground'},
{n:'スライディングキック',d:4,c:'ground'},{n:'ストンピング連打',d:3,c:'ground'},
{n:'ヘアプル・スラム',d:3,c:'ground'},{n:'フェイスウォッシュ',d:4,c:'ground'},{n:'ダブルニードロップ',d:5,c:'ground'},
{n:'スクールボーイ',d:4,c:'rollup'},{n:'首固め',d:4,c:'rollup'},
{n:'スモール・パッケージ',d:5,c:'rollup'},{n:'ラ・マヒストラル',d:5,c:'rollup'},
{n:'ウラカン・ラナ',d:5,c:'rollup'},{n:'回転エビ固め',d:5,c:'rollup'},
{n:'ヨーロピアン・クラッチ',d:5,c:'rollup'}
];
const styleMoves={
Grappler:[{n:'パワーボム',d:14,c:'throw'},{n:'シットアウト・パワーボム',d:15,c:'throw'},
{n:'ジャーマン・スープレックス',d:13,c:'throw'},{n:'チョークスラム',d:13,c:'throw'},
{n:'デスバレーボム',d:14,c:'throw'},{n:'バックドロップ',d:13,c:'throw'},
{n:'ラストライド',d:16,c:'throw'},{n:'垂直落下式ブレーンバスター',d:14,c:'throw'},
{n:'力強いラリアット',d:12,c:'strike'},{n:'頭突き',d:11,c:'strike'},
{n:'カナディアン・バックブリーカー',d:10,c:'submission'},{n:'アルゼンチン・バックブリーカー',d:11,c:'submission'}],
Speed:[{n:'フランケンシュタイナー',d:12,c:'throw'},{n:'トルネードDDT',d:13,c:'throw'},
{n:'シャイニング・ウィザード',d:12,c:'strike'},{n:'ムーンサルト・プレス',d:15,c:'aerial'},
{n:'シューティング・スター・プレス',d:16,c:'aerial'},{n:'450スプラッシュ',d:15,c:'aerial'},
{n:'フロッグ・スプラッシュ',d:13,c:'aerial'},{n:'スワントン・ボム',d:14,c:'aerial'},
{n:'トペ・コンヒーロ',d:11,c:'aerial'},
{n:'ダイビング・セントーン',d:10,c:'aerial'},{n:'ドラゴン・スクリュー',d:10,c:'throw'},
{n:'ハリケーンラナ',d:12,c:'throw'}],
Technique:[{n:'アームバー',d:11,c:'submission'},{n:'フィギュア・フォー・レッグロック',d:12,c:'submission'},
{n:'シャープシューター',d:13,c:'submission'},{n:'STF',d:12,c:'submission'},
{n:'三角絞め',d:12,c:'submission'},{n:'クロスフェイス',d:13,c:'submission'},
{n:'卍固め',d:14,c:'submission'},{n:'ドラゴンスリーパー',d:13,c:'submission'},
{n:'キムラロック',d:11,c:'submission'},{n:'タイガー・スープレックス',d:14,c:'throw'},
{n:'ドラゴン・スープレックス',d:15,c:'throw'},{n:'フィッシャーマン・スープレックス',d:13,c:'throw'}],
Allround:[{n:'ファルコンアロー',d:13,c:'throw'},{n:'みちのくドライバーII',d:14,c:'throw'},
{n:'エクスプローダー',d:12,c:'throw'},{n:'ノーザンライツ・スープレックス',d:12,c:'throw'},
{n:'ダブルアーム・スープレックス',d:13,c:'throw'},{n:'リアネイキッドチョーク',d:11,c:'submission'},
{n:'テキサス・クローバーホールド',d:12,c:'submission'},{n:'アンクル・ロック',d:11,c:'submission'},
{n:'フェニックス・スプラッシュ',d:15,c:'aerial'},{n:'ダイビング・ボディ・プレス（大）',d:11,c:'aerial'},
{n:'スピアー',d:12,c:'strike'},{n:'インプラントDDT',d:13,c:'throw'}],
Striker:[{n:'シャイニング・ウィザード（打）',d:13,c:'strike'},{n:'ジャンピングニー',d:12,c:'strike'},
{n:'ハイキック',d:11,c:'strike'},{n:'バズソーキック',d:14,c:'strike'},
{n:'PK',d:11,c:'strike'},{n:'ランニングエルボー',d:13,c:'strike'},
{n:'スピニングバックフィスト',d:12,c:'strike'},{n:'ケンカキック',d:15,c:'strike'},
{n:'エルボー連打',d:10,c:'strike'},{n:'コーナーラッシュ',d:11,c:'strike'},
{n:'パイルドライバー',d:14,c:'throw'},{n:'ツームストン・パイルドライバー',d:16,c:'throw'}],
Submission:[{n:'ギロチンチョーク',d:13,c:'submission'},{n:'肩固め',d:12,c:'submission'},
{n:'ヒール・ホールド',d:13,c:'submission'},{n:'ロメロ・スペシャル',d:14,c:'submission'},
{n:'テキサス・クローバーホールド（専）',d:13,c:'submission'},{n:'リアネイキッドチョーク（専）',d:12,c:'submission'},
{n:'アンクル・ロック（専）',d:12,c:'submission'},{n:'クロスフェイス（専）',d:14,c:'submission'},
{n:'卍固め（専）',d:15,c:'submission'},{n:'フィギュア・フォー（専）',d:14,c:'submission'},
{n:'バックドロップ（専）',d:13,c:'throw'},{n:'ドラゴン・スクリュー（専）',d:11,c:'throw'}],
Brawler:[{n:'エルボースマッシュ',d:12,c:'strike'},{n:'バックハンドブロー',d:11,c:'strike'},
{n:'ヘッドバット連打',d:11,c:'strike'},{n:'コーナーラッシュ（喧）',d:12,c:'strike'},
{n:'パイルドライバー（喧）',d:15,c:'throw'},{n:'ツームストン・パイルドライバー（喧）',d:16,c:'throw'},
{n:'チョークスラム（喧）',d:14,c:'throw'},{n:'サイドウォークスラム',d:12,c:'throw'},
{n:'ランニングパワースラム',d:13,c:'throw'},{n:'ネックハンギングツリー',d:12,c:'submission'},
{n:'フェイスウォッシュ連打',d:10,c:'ground'},{n:'ストンピング乱打',d:11,c:'ground'}]
};
const catW={
Grappler:{strike:30,throw:30,submission:5,aerial:5,ground:15,rollup:5},
Speed:{strike:20,throw:15,submission:10,aerial:35,ground:5,rollup:10},
Technique:{strike:15,throw:20,submission:30,aerial:5,ground:10,rollup:15},
Allround:{strike:25,throw:25,submission:15,aerial:15,ground:10,rollup:10},
Striker:{strike:45,throw:15,submission:5,aerial:10,ground:15,rollup:5},
Submission:{strike:10,throw:10,submission:45,aerial:5,ground:15,rollup:10},
Brawler:{strike:30,throw:25,submission:5,aerial:5,ground:20,rollup:5}
};

// ═══ COMMENTARY ═══
const CMT={
atk:{
  Opening:["{a}、{m}。","{a}が{m}を仕掛ける。","{a}の{m}。序盤から攻めていく。","{a}、まずは{m}。"],
  Mid:["{a}、{m}！","{a}の{m}が決まった！","ここで{a}、{m}！ 攻勢を強める！","おっと{a}、{m}！"],
  End:["{a}の{m}だーっ！","{a}、ここで{m}！ 畳みかける！","{a}、渾身の{m}！","出たーっ！ {a}の{m}！"],
  Climax:["{a}ーーっ！ {m}ーーーっ！！","これは決まったかーーっ！ {a}の{m}！",
    "{a}、ここで{m}を放つーっ！ 決着なるかーーっ！","まさかの{m}！ {a}が勝負に出たーっ！"],
  big:["大技だーーっ！ {a}の{m}ーーっ！！","{a}、必殺の{m}ーっ！ これは大きい！","とんでもないのが来たーっ！ {m}！"]
},
dmg:{
  light:["{d}、受け止めるも{v}のダメージ。","{d}に{v}ダメージ。まだ余裕の表情。","浅い！ {v}ダメージに留まる。"],
  medium:["{d}に{v}ダメージ！ 効いている！","モロに入った！ {d}に{v}ダメージ！","{d}、{v}ダメージ！ 表情が歪む！"],
  heavy:["{d}に{v}の大ダメージーーっ！","これは効いたーっ！ {v}ダメージ！ {d}がぐらつく！",
    "{v}ダメージ！ {d}、立っていられるかーーっ！"]
},
sit:{
  half:["{d}、体力が半分を切った！ ここからが正念場だ！"],
  quarter:["{d}、もう後がない！ 絶体絶命のピンチ！"],
  dominant:["完全に{a}のペースだ！ 一方的な展開！"],
  reversal:["流れが変わった！ {a}が反撃に出る！"],
  finFall:["カウント3ーーっ！ {a}、{m}からのフォール勝ち！"],
  finGU:["{d}がタップ！ {a}、{m}でギブアップを奪った！"],
  finJudge:["ここで時間切れ！ HP判定の結果…{w}の勝利！"],
  finDraw:["ここで時間切れ！ HP判定の結果…ドロー！"],
  rollFail:["カウント2で返したーっ！ {d}、まだ終わらない！"],
  rollOK:["入ったーーっ！ まさかの丸め込み3カウント！ 大金星だーーっ！"],
  kickout:["{d}、カウント2.9で返したーーーっ！！ まだ終わらない！",
    "返したーーっ！ {d}の意地！ 驚異の精神力で生き残った！",
    "嘘だろーーっ！ {d}がフォールを返した！ 会場が沸いている！",
    "{d}、執念のキックアウト！ この試合はまだ終わらないーっ！"],
  kickout2:["またしても返したーーっ！ {d}、一体どこにそんな力が…！"],
  kickoutAtk:["なっ…！ 今のを返すの…！？","嘘でしょ…！","しぶとい…！","まだ立つの…！？"],
  guEscape:["ロープに手が届いたーーっ！ {d}、間一髪のロープブレイク！",
    "{d}、必死にロープへ！ ギリギリで逃れた！ なんという執念！",
    "返したーーっ！ {d}、地獄の関節地獄から生還！",
    "{d}の根性！ あの極まった体勢からロープを掴んだーっ！"],
  guEscape2:["またしてもロープへ！ {d}、驚異の生命力で脱出ーっ！"],
  guEscapeAtk:["くっ…ロープが…！","ここで逃げるか…！","…しつこいわね","まだ諦めないの…！？"],
  climaxReturn:["{d}の目が変わった！ ここから逆転なるかーーっ！"]
},
defR:{
  high:["くっ…！","効かないよ…！","その程度…！","まだまだっ！"],
  mid:["ぐっ…やるね…！","痛い…！ でもまだ…！","うぅっ…！","負けない…！"],
  low:["ああっ…！","も、もう…っ！","まだ…まだ終わらない…！","くそ…っ…！","立て…立つんだ…！"]
},
atkC:{
  normal:["いくよ！","はあっ！","そこっ！","もらった！"],
  big:["これで…終わりだっ！","決めるっ！","受けてみなさいっ！","覚悟しなっ！"]
}};
function pk(a){return a[Math.floor(Math.random()*a.length)]}
function tpl(t,v){return t.replace(/\{(\w)\}/g,(_,k)=>v[k]||'')}

// ═══ CONSTANTS ═══
const MAX_T=20;
const PHASES=[
  {name:'Opening',min:1,max:4,mult:0.9,sCh:20,tempo:2000},
  {name:'Mid',min:5,max:8,mult:1.05,sCh:40,tempo:2000},
  {name:'End',min:9,max:12,mult:1.2,sCh:55,tempo:2500},
  {name:'Climax',min:13,max:20,mult:1.4,sCh:70,tempo:3000}
];
function clamp(v,lo,hi){return Math.max(lo,Math.min(hi,v))}
function phase(t){return PHASES.find(p=>t>=p.min&&t<=p.max)||PHASES[3]}
function ov(c){return Math.round((c.pw+c.sp+c.te+c.st)/4)}
function wRand(w){const e=Object.entries(w),t=e.reduce((s,[,v])=>s+v,0);let r=Math.random()*t;
  for(const[k,v]of e){r-=v;if(r<=0)return k}return e[e.length-1][0]}
function selMove(style,turn){
  const ph=phase(turn),use=Math.random()*100<ph.sCh,pool=use?styleMoves[style]:commonMoves;
  const cat=wRand(catW[style]),cands=pool.filter(m=>m.c===cat);
  return cands.length?pk(cands):pk(pool);
}

// ═══ AUDIO ═══
let ac=null;
function ctx(){if(!ac)ac=new(window.AudioContext||window.webkitAudioContext)();return ac}
function mkNoise(dur,g){try{const c=ctx(),b=c.createBuffer(1,c.sampleRate*dur,c.sampleRate),
  ch=b.getChannelData(0);for(let i=0;i<ch.length;i++)ch[i]=Math.random()*2-1;
  const s=c.createBufferSource();s.buffer=b;const gn=c.createGain();
  gn.gain.setValueAtTime(g,c.currentTime);gn.gain.exponentialRampToValueAtTime(0.001,c.currentTime+dur);
  s.connect(gn).connect(c.destination);s.start();s.stop(c.currentTime+dur)}catch(e){}}
function mkNoiseHP(dur,g,hpFreq){try{const c=ctx(),b=c.createBuffer(1,c.sampleRate*dur,c.sampleRate),
  ch=b.getChannelData(0);for(let i=0;i<ch.length;i++)ch[i]=Math.random()*2-1;
  const s=c.createBufferSource();s.buffer=b;const gn=c.createGain();
  gn.gain.setValueAtTime(g,c.currentTime);gn.gain.exponentialRampToValueAtTime(0.001,c.currentTime+dur);
  const hp=c.createBiquadFilter();hp.type='highpass';hp.frequency.value=hpFreq;
  s.connect(hp).connect(gn).connect(c.destination);s.start();s.stop(c.currentTime+dur)}catch(e){}}
function osc(type,freq,freqEnd,dur,gain){try{const c=ctx(),o=c.createOscillator(),g=c.createGain();
  o.type=type;o.frequency.setValueAtTime(freq,c.currentTime);
  if(freqEnd)o.frequency.exponentialRampToValueAtTime(freqEnd,c.currentTime+dur);
  g.gain.setValueAtTime(gain,c.currentTime);g.gain.exponentialRampToValueAtTime(0.001,c.currentTime+dur);
  o.connect(g).connect(c.destination);o.start();o.stop(c.currentTime+dur)}catch(e){}}

const sfx={
  hover(){osc('sine',1200,1800,0.06,0.05)},
  // v3.2: 5-note chariiin
  select(){try{const c=ctx();[1047,1319,1568,2093,2637].forEach((f,i)=>{setTimeout(()=>{
    const o=c.createOscillator(),g=c.createGain();o.type='sine';
    o.frequency.setValueAtTime(f,c.currentTime);
    const vib=c.createOscillator();vib.type='sine';vib.frequency.value=6;
    const vibG=c.createGain();vibG.gain.value=3;vib.connect(vibG).connect(o.frequency);vib.start();
    g.gain.setValueAtTime(0.07,c.currentTime);g.gain.exponentialRampToValueAtTime(0.001,c.currentTime+0.3);
    o.connect(g).connect(c.destination);o.start();o.stop(c.currentTime+0.3);vib.stop(c.currentTime+0.3)
  },i*20)})}catch(e){}},
  // v3.2: lock-in SE (7-note chime + shimmer)
  lockIn(){try{const c=ctx();
    // Phase A: low impact
    osc('sine',100,50,0.08,0.08);
    // Phase B: 7-note chime
    setTimeout(()=>{[523,659,784,988,1047,1319,1568].forEach((f,i)=>{setTimeout(()=>{
      const o=c.createOscillator(),g=c.createGain();o.type='sine';
      o.frequency.setValueAtTime(f,c.currentTime);
      const vib=c.createOscillator();vib.type='sine';vib.frequency.value=5;
      const vibG=c.createGain();vibG.gain.value=4;vib.connect(vibG).connect(o.frequency);vib.start();
      g.gain.setValueAtTime(0.06,c.currentTime);g.gain.exponentialRampToValueAtTime(0.001,c.currentTime+0.6);
      o.connect(g).connect(c.destination);o.start();o.stop(c.currentTime+0.6);vib.stop(c.currentTime+0.6)
    },i*30)})},50);
    // Phase C: shimmer
    setTimeout(()=>mkNoiseHP(0.5,0.04,3000),300);
    // Phase D: low sustain
    setTimeout(()=>osc('sine',80,40,0.4,0.03),500);
  }catch(e){}},
  deselect(){osc('sine',900,400,0.12,0.05)},
  // v3.3: SF2-style dramatic fight SE "ドドドドドーン！"
  fightStart(){try{const c=ctx();
    // Phase 1: low drum roll (60Hz pulses x6, escalating gain)
    [0,30,60,90,120,150].forEach((t,i)=>setTimeout(()=>osc('sine',60,30,0.04,0.08+i*0.014),t));
    // Phase 2: ascending sweep (150→3000Hz)
    setTimeout(()=>osc('sine',150,3000,0.4,0.12),200);
    // Phase 3: brief silence (50ms gap)
    // Phase 4: explosion burst + metal chord
    setTimeout(()=>{
      mkNoise(0.2,0.25);
      [262,330,392,523,659,784,1047].forEach(f=>osc('sine',f,null,0.6,0.18));
    },650);
    // Phase 5: low drone sustain
    setTimeout(()=>osc('sine',50,25,0.8,0.06),850);
  }catch(e){}},
  ready(){osc('sine',200,400,0.15,0.06)},
  // Damage-scaled hit SE
  hitStrike(dr){const g=0.12*dr,d=0.08*(0.8+dr*0.4);mkNoise(d,g);osc('sine',2000,800,0.05*d/0.08,0.1*dr)},
  hitThrow(dr){const g=0.1*dr,d=0.12*(0.8+dr*0.4);mkNoise(d,g);osc('sine',120,60,0.15*d/0.12,0.12*dr)},
  hitSub(dr){const g=0.08*dr,d=0.2*(0.8+dr*0.4);osc('sawtooth',150,250,d,g)},
  hitAerial(dr){const g=0.08*dr,d=0.15*(0.8+dr*0.4);osc('sine',1500,300,d,g);setTimeout(()=>{mkNoise(0.15*dr,0.12*dr);osc('sine',100,50,0.2,0.12*dr)},150)},
  hitGround(dr){const g=0.08*dr,d=0.12*(0.8+dr*0.4);mkNoise(d,g);osc('sawtooth',180,80,d,0.09*dr)},
  hitRollup(dr){osc('triangle',2000,600,0.06,0.08*dr)},
  count(){osc('sine',80,40,0.15,0.15)},
  kickout(){osc('square',200,800,0.1,0.1);mkNoise(0.15,0.08)},
  kickoutSE(){try{mkNoise(0.2,0.12);osc('sine',100,60,0.15,0.1);setTimeout(()=>mkNoiseHP(0.3,0.06,2000),100)}catch(e){}},
  guEscapeSE(){try{osc('sawtooth',80,200,0.2,0.1);mkNoiseHP(0.3,0.08,1500);setTimeout(()=>mkNoiseHP(0.4,0.05,2500),150)}catch(e){}},
  heartbeatSE(){try{osc('sine',50,30,0.3,0.12);setTimeout(()=>osc('sine',50,30,0.3,0.12),400)}catch(e){}},
  finImpact(){mkNoise(0.3,0.15);osc('sawtooth',150,40,0.4,0.18)},
  finChime(){try{const c=ctx();[523,659,784,1047].forEach((f,i)=>{setTimeout(()=>osc('sine',f,null,0.5,0.08),i*100)})}catch(e){}},
  gong(){osc('sine',1200,800,0.8,0.12)},
  gongStart(){try{const c=ctx();osc('sine',1200,600,1.2,0.15);osc('sine',2400,1200,0.8,0.06);mkNoiseHP(0.3,0.05,4000)}catch(e){}},
  phaseChg(){try{[600,900].forEach((f,i)=>{setTimeout(()=>osc('sine',f,null,0.2,0.06),i*80)})}catch(e){}},
  // v3.3: grand victory fanfare "テレテテテ♪" (~2.5s)
  victoryFanfare(){try{const c=ctx();
    // Phase A: powerful drum hits (60Hz x4, 80ms each, 60ms intervals, gain 0.15)
    [0,60,120,180].forEach(t=>setTimeout(()=>osc('sine',60,30,0.08,0.15),t));
    // Phase B: ascending fanfare C5→E5→G5→C6 (square+sine layer, 120ms each, 40ms overlap)
    setTimeout(()=>{
      [523,659,784,1047].forEach((f,i)=>setTimeout(()=>{
        osc('square',f,null,0.12,0.08);osc('sine',f,null,0.15,0.15);
      },i*80));
    },400);
    // Phase C: peak grand chord C5-E5-G5-B5-C6-E6 (6 notes, gain 0.20, 1200ms decay)
    setTimeout(()=>{
      [523,659,784,988,1047,1319].forEach(f=>{
        const o2=c.createOscillator(),g2=c.createGain();o2.type='sine';
        o2.frequency.setValueAtTime(f,c.currentTime);
        g2.gain.setValueAtTime(0.20,c.currentTime);
        g2.gain.exponentialRampToValueAtTime(0.001,c.currentTime+1.2);
        o2.connect(g2).connect(c.destination);o2.start();o2.stop(c.currentTime+1.2);
      });
    },900);
    // Phase D: sparkle decorations (C7-E7-G7, 100ms intervals, gain 0.08)
    setTimeout(()=>{[2093,2637,3136].forEach((f,i)=>setTimeout(()=>osc('sine',f,null,0.2,0.08),i*100))},1500);
    // Phase E: solemn bass (C3, gain 0.10, 600ms slow decay)
    setTimeout(()=>osc('sine',131,65,0.6,0.10),1800);
  }catch(e){}}
};
function hitSE(cat,dmg){
  const dr=clamp(dmg/20,0.3,1.5);
  const fn={strike:sfx.hitStrike,throw:sfx.hitThrow,submission:sfx.hitSub,
    aerial:sfx.hitAerial,ground:sfx.hitGround,rollup:sfx.hitRollup}[cat];
  if(fn)fn(dr);
}

// ═══ SUSPENSE DRONE SE (v3.5) ═══
function startDrone(withHeartbeat){
  stopDrone();
  try{
    const c=ctx(),now=c.currentTime;
    // Layer 1: 80Hz sine with LFO
    const o1=c.createOscillator(),g1=c.createGain();
    o1.type='sine';o1.frequency.value=80;
    const lfo1=c.createOscillator(),lfoG1=c.createGain();
    lfo1.type='sine';lfo1.frequency.value=0.3;lfoG1.gain.value=8;
    lfo1.connect(lfoG1).connect(o1.frequency);lfo1.start(now);
    g1.gain.value=0.04;o1.connect(g1).connect(c.destination);o1.start(now);
    // Layer 2: 120Hz sine with LFO
    const o2=c.createOscillator(),g2=c.createGain();
    o2.type='sine';o2.frequency.value=120;
    const lfo2=c.createOscillator(),lfoG2=c.createGain();
    lfo2.type='sine';lfo2.frequency.value=0.5;lfoG2.gain.value=10;
    lfo2.connect(lfoG2).connect(o2.frequency);lfo2.start(now);
    g2.gain.value=0.03;o2.connect(g2).connect(c.destination);o2.start(now);
    const nodes={o1,g1,lfo1,o2,g2,lfo2,hb:null,hbG:null};
    // Heartbeat for giveup
    if(withHeartbeat){
      const hb=c.createOscillator(),hbG=c.createGain();
      hb.type='sine';hb.frequency.value=50;
      hbG.gain.value=0;
      // LFO for heartbeat pulsing at ~0.8Hz
      const hbLFO=c.createOscillator(),hbLFOG=c.createGain();
      hbLFO.type='square';hbLFO.frequency.value=0.8;hbLFOG.gain.value=0.05;
      hbLFO.connect(hbLFOG).connect(hbG.gain);hbLFO.start(now);
      hb.connect(hbG).connect(c.destination);hb.start(now);
      nodes.hb=hb;nodes.hbG=hbG;nodes.hbLFO=hbLFO;
    }
    S.droneNodes=nodes;
  }catch(e){}
}
function stopDrone(){
  if(!S.droneNodes)return;
  try{
    const c=ctx(),now=c.currentTime,n=S.droneNodes;
    // Fade out 200ms
    [n.g1,n.g2,n.hbG].forEach(g=>{if(g){g.gain.setValueAtTime(g.gain.value,now);g.gain.exponentialRampToValueAtTime(0.001,now+0.2)}});
    setTimeout(()=>{
      try{[n.o1,n.lfo1,n.o2,n.lfo2,n.hb,n.hbLFO].forEach(o=>{if(o)try{o.stop()}catch(e){}})}catch(e){}
    },250);
    S.droneNodes=null;
  }catch(e){S.droneNodes=null}
}

// ═══ FINISH CLICK SYSTEM (v3.5) ═══
const FINISH_SUSPENSE={
  fall:["入ったか…！？ スリーカウントなるかーーーっ！！",
    "カウントツー！ 返せるのか！？ 返せないのか！？",
    "万事休すか…！ {d}、ここが正念場だーっ！",
    "このまま決まってしまうのか…！！",
    "会場が息を飲んでいる…！ {d}の運命やいかにーーっ！"],
  gu:["タップするのか…！？ しないのか…！？",
    "ロープに手が届くか…！ {d}、必死に腕を伸ばす…！！",
    "{d}の表情が…！ 耐えられるのか！？",
    "レフェリーが確認している…！ ギブアップか…！？",
    "極まっている…！ {d}、絶体絶命だーーっ！"],
  rollup:["まさかの丸め込み…！ これで決まるのか！？"]
};

function showFinishClickBtn(type,v){
  const btn=document.getElementById('finishBtn');
  const ov=document.getElementById('finishOverlay');
  const nBtn=document.getElementById('nBtn');
  if(nBtn)nBtn.style.display='none';
  const actBar=nBtn?nBtn.closest('.action-bar'):null;
  if(actBar)actBar.style.display='none';
  const labels={'フォール':'スリーカウント…！？','ギブアップ':'ギブアップ…！？','丸め込み':'カウント…！？'};
  btn.textContent=labels[type]||'…！？';
  btn.disabled=false;
  ov.classList.add('show');
  // Show narration suspense text
  const box=document.getElementById('narBox');
  const tKey=type==='ギブアップ'?'gu':type==='丸め込み'?'rollup':'fall';
  const suspText=tpl(pk(FINISH_SUSPENSE[tKey]),v);
  if(box)box.innerHTML=`<div class="nar-line nar-finish show">${suspText}</div>`;
  // Start drone
  startDrone(type==='ギブアップ');
  // Delayed button appearance (300ms)
  setTimeout(()=>{btn.classList.add('show')},100);
  // One-shot click handler
  const handler=()=>{
    btn.disabled=true;btn.classList.remove('show');
    ov.classList.remove('show');
    stopDrone();
    btn.removeEventListener('click',handler);
    document.removeEventListener('keydown',kHandler);
    resolveFinishClick();
  };
  const kHandler=(e)=>{if(e.code==='Space'||e.code==='Enter'){e.preventDefault();handler()}};
  btn.addEventListener('click',handler);
  document.addEventListener('keydown',kHandler);
  // Prevent overlay clicks from doing anything (except button)
  ov.addEventListener('click',e=>e.stopPropagation());
}

function resolveFinishClick(){
  const p=S.pendingFinishResult;if(!p)return;
  S.awaitingFinishClick=false;
  if(p.type==='フォール'){resolveFallClick(p)}
  else if(p.type==='ギブアップ'){resolveGUClick(p)}
  else if(p.type==='丸め込み'){resolveRollupClick(p)}
}

function resolveFallClick(p){
  const v={a:p.atk.name,d:p.def.name,m:p.moveName,w:p.atk.name};
  const ds=p.defSide,as=p.atkSide;
  if(!p.isKickout){
    // 3 COUNT! Finish!
    showCountText('3ーーーーっ！！！','white');
    sfx.count();sfx.finImpact();
    const flash=document.createElement('div');flash.className='finish-flash';
    document.body.appendChild(flash);setTimeout(()=>flash.remove(),400);
    const box=document.getElementById('narBox');
    if(box)box.innerHTML=`<div class="nar-line nar-finish show">${tpl(pk(CMT.sit.finFall),v)}</div>`;
    p.log+=` ★ ${p.atk.name}がフォールで勝利！`;
    S.log.unshift(p.log);S.log=S.log.slice(0,12);
    S.finType='フォール';S.winner=as;
    sfx.finChime();
    setTimeout(()=>{showNBtn();showResult()},2000);
  }else{
    // KICKOUT! — v3.5: HP recovery happens here (post-click)
    const recoveryHP=getKickoutRecoveryHP(p.def);
    p.def.hp=recoveryHP;p.def.kickoutCount+=1;
    updHP(ds,p.def);
    showCountText('返したーーーーっ！！','white');
    sfx.kickoutSE();
    const flash=document.createElement('div');flash.className='finish-flash';
    document.body.appendChild(flash);setTimeout(()=>flash.remove(),400);
    const dp=document.getElementById(`panel-${ds}`);
    if(dp){dp.classList.add('kickout-flash');setTimeout(()=>dp.classList.remove('kickout-flash'),600)}
    const box=document.getElementById('narBox');
    const koLine=p.def.kickoutCount>=2?tpl(pk(CMT.sit.kickout2),v):tpl(pk(CMT.sit.kickout),v);
    if(box)box.innerHTML=`<div class="nar-line nar-finish show">${koLine}</div>`;
    showSp(as,pk(CMT.sit.kickoutAtk),'t-def');
    applyClimaxReturnEffects(ds,p.def,v);
    p.log+=` → カウント2.9で返した！`;S.log.unshift(p.log);S.log=S.log.slice(0,12);
    updPanelState(ds,p.def);
    S.turn++;
    S.pendingFinishResult=null;
    if(S.turn>MAX_T){doTimeout(()=>0);return}
    showNBtn();endAnim();
  }
}

function resolveGUClick(p){
  const v={a:p.atk.name,d:p.def.name,m:p.moveName,w:p.atk.name};
  const ds=p.defSide,as=p.atkSide;
  if(!p.isKickout){
    // GIVEUP!
    showCountText(p.def.name+'がタップ！！','red-gold');
    sfx.gong();
    const box=document.getElementById('narBox');
    if(box)box.innerHTML=`<div class="nar-line nar-finish show">${tpl(pk(CMT.sit.finGU),v)}</div>`;
    p.log+=` ★ ${p.atk.name}がギブアップで勝利！`;
    S.log.unshift(p.log);S.log=S.log.slice(0,12);
    S.finType='ギブアップ';S.winner=as;
    sfx.finChime();
    setTimeout(()=>{showNBtn();showResult()},2000);
  }else{
    // ROPE BREAK! — v3.5: HP recovery happens here (post-click)
    const recoveryHP=getKickoutRecoveryHP(p.def);
    p.def.hp=recoveryHP;p.def.kickoutCount+=1;
    updHP(ds,p.def);
    showCountText('ロープ！ ロープブレイクーーっ！！','white');
    sfx.guEscapeSE();
    const flash=document.createElement('div');flash.className='finish-flash';
    document.body.appendChild(flash);setTimeout(()=>flash.remove(),400);
    const dp=document.getElementById(`panel-${ds}`);
    if(dp){dp.classList.add('kickout-flash');setTimeout(()=>dp.classList.remove('kickout-flash'),600)}
    const box=document.getElementById('narBox');
    const escLine=p.def.kickoutCount>=2?tpl(pk(CMT.sit.guEscape2),v):tpl(pk(CMT.sit.guEscape),v);
    if(box)box.innerHTML=`<div class="nar-line nar-finish show">${escLine}</div>`;
    showSp(as,pk(CMT.sit.guEscapeAtk),'t-def');
    applyClimaxReturnEffects(ds,p.def,v);
    p.log+=` → ロープブレイクで脱出！`;S.log.unshift(p.log);S.log=S.log.slice(0,12);
    updPanelState(ds,p.def);
    S.turn++;
    S.pendingFinishResult=null;
    if(S.turn>MAX_T){doTimeout(()=>0);return}
    showNBtn();endAnim();
  }
}

function resolveRollupClick(p){
  const v={a:p.atk.name,d:p.def.name,m:p.moveName,w:p.atk.name};
  const ds=p.defSide,as=p.atkSide;
  if(!p.isKickout){
    // ROLLUP SUCCESS!
    showCountText('3ーーーっ！！','white');
    sfx.finImpact();
    const flash=document.createElement('div');flash.className='finish-flash';
    document.body.appendChild(flash);setTimeout(()=>flash.remove(),400);
    p.def.hp=0;updHP(ds,p.def);
    const box=document.getElementById('narBox');
    if(box)box.innerHTML=`<div class="nar-line nar-finish show">${tpl(pk(CMT.sit.rollOK),v)}</div>`;
    p.log+=' ★ 丸め込み3カウント！';S.log.unshift(p.log);S.log=S.log.slice(0,12);
    S.winner=as;S.finType='フォール';
    sfx.finChime();
    setTimeout(()=>{showNBtn();showResult()},2000);
  }else{
    // ROLLUP FAIL
    showCountText('返したーーっ！','white');
    sfx.kickout();
    const box=document.getElementById('narBox');
    const nD=document.getElementById('nD');
    if(nD)nD.textContent=tpl(pk(CMT.sit.rollFail),v);
    else if(box)box.innerHTML=`<div class="nar-line nar-finish show">${tpl(pk(CMT.sit.rollFail),v)}</div>`;
    p.log+=' → カウント2で返した！';S.log.unshift(p.log);S.log=S.log.slice(0,12);
    S.turn++;S.pendingFinishResult=null;
    if(S.turn>MAX_T){doTimeout(()=>0);return}
    showNBtn();endAnim();
  }
}

function showCountText(text,cls){
  const el=document.createElement('div');
  el.className=`finish-count-text ${cls}`;el.textContent=text;
  document.body.appendChild(el);
  requestAnimationFrame(()=>el.classList.add('show'));
  setTimeout(()=>el.remove(),1000);
}
function showNBtn(){
  const nBtn=document.getElementById('nBtn');if(nBtn){nBtn.style.display='';
    const actBar=nBtn.closest('.action-bar');if(actBar)actBar.style.display='';}
}

// ═══ STATE ═══
const S={screen:'SELECT',selL:null,selR:null,confirmId:null,turn:1,mom:0,prevMom:0,
  L:null,R:null,log:[],winner:null,finType:null,anim:false,
  halfTrig:{l:false,r:false},qtrTrig:{l:false,r:false},dangerTrig:{l:false,r:false},
  awaitingFinishClick:false,pendingFinishResult:null,droneNodes:null};
const silSVG=`<svg viewBox="0 0 100 120" xmlns="http://www.w3.org/2000/svg"><circle cx="50" cy="30" r="18"/><ellipse cx="50" cy="85" rx="30" ry="35"/></svg>`;

// ═══ SELECT ═══
function renderSelect(){
  const ct=document.getElementById('screenContainer');
  const hdr=document.querySelector('.site-title');if(hdr)hdr.textContent='CHARACTER SELECT';
  const sub=document.getElementById('headerSub');if(sub)sub.textContent='学園女子プロレス — 対戦カード選択';
  const lc=C.find(c=>c.id===S.selL),rc=C.find(c=>c.id===S.selR),ok=S.selL&&S.selR;
  let h=`<div class="matchup-indicator">
    <div class="matchup-slot left ${lc?'filled':''}"><span class="slot-label">Blue Corner</span>
      ${lc?`<span>${lc.name}</span>`:'<span class="slot-empty">未選択</span>'}</div>
    <div class="matchup-vs">VS</div>
    <div class="matchup-slot right ${rc?'filled':''}"><span class="slot-label">Red Corner</span>
      ${rc?`<span>${rc.name}</span>`:'<span class="slot-empty">未選択</span>'}</div>
  </div>
  <div class="fight-btn-wrap"><button class="btn-fight" id="fBtn" ${ok?'':'disabled'}>
    FIGHT<span class="btn-fight-sub">試合開始</span></button></div>
  <div class="roster-grid">`;
  C.forEach((c,i)=>{
    const isL=c.id===S.selL,isR=c.id===S.selR;
    const cls=isL?' selected-left':isR?' selected-right':' selectable';
    const rc2=c.role.toLowerCase();
    let cl='';if(isL)cl='<div class="corner-label blue">Blue Corner</div>';
    else if(isR)cl='<div class="corner-label red">Red Corner</div>';
    h+=`<div class="char-card${cls}" style="animation-delay:${i*0.04}s" data-id="${c.id}">
      <div class="card-image-area">
        <div class="card-badge-style">${c.style}</div>
        <div class="card-badge-role ${rc2}">${c.role}</div>${cl}
        <img src="image/bust_${c.id}.jpg" alt="${c.name}" onerror="this.style.display='none';this.nextElementSibling.style.display='flex'">
        <div class="card-placeholder" style="display:none">${silSVG}</div>
      </div>
      <div class="card-info"><div class="card-text">
        <div class="card-name">${c.name}</div>
        <div class="card-style-label">${c.style} / ${c.h}cm</div>
        <div class="card-mini-stats">
          <span>PWR <span class="sv">${c.pw}</span></span><span>SPD <span class="sv">${c.sp}</span></span>
          <span>TEC <span class="sv">${c.te}</span></span><span>STA <span class="sv">${c.st}</span></span></div>
      </div><div class="card-overall"><div class="overall-num">${ov(c)}</div>
        <div class="overall-label">Overall</div></div></div></div>`;
  });
  h+=`</div>`;ct.innerHTML=h;
  ct.querySelectorAll('.char-card').forEach(card=>{
    card.addEventListener('click',()=>{
      const id=+card.dataset.id;
      // Deselect if already selected
      if(S.selL===id){S.selL=S.selR;S.selR=null;sfx.deselect();renderSelect();return}
      if(S.selR===id){S.selR=null;sfx.deselect();renderSelect();return}
      // Both filled? do nothing
      if(S.selL&&S.selR)return;
      // Open confirm modal
      sfx.select();
      showConfirmModal(id);
    });
    card.addEventListener('mouseenter',sfx.hover);
  });
  const fb=document.getElementById('fBtn');if(fb)fb.addEventListener('click',()=>{startMatch()});
}

// ═══ CONFIRM MODAL ═══
function showConfirmModal(charId){
  const c=C.find(x=>x.id===charId);if(!c)return;
  S.confirmId=charId;
  const mo=document.getElementById('modalOverlay');
  const isFirst=!S.selL;
  const cornerText=isFirst?'→ BLUE CORNER':'→ RED CORNER';
  const cornerCls=isFirst?'blue':'red';
  mo.innerHTML=`<div class="modal-box">
    <button class="modal-close" id="mClose">&times;</button>
    <div class="modal-grid">
      <div class="modal-image-section clickable" id="mImgSec">
        <img src="image/bust_${c.id}.jpg" alt="${c.name}" onerror="this.style.display='none';this.nextElementSibling.style.display='flex'">
        <div class="modal-image-placeholder" style="display:none">${silSVG}</div>
        <div class="modal-ov-badge"><div class="modal-ov-num">${ov(c)}</div><div class="modal-ov-label">Overall</div></div>
      </div>
      <div class="modal-info-section">
        <div class="modal-corner-hint ${cornerCls}">${cornerText}</div>
        <div class="modal-section-border">
          <div class="modal-section-title">Profile</div>
          <div class="modal-char-name">${c.name}</div>
          <div class="modal-tags">
            <span class="modal-tag style-tag">${c.style}</span>
            <span class="modal-tag role-tag ${c.role.toLowerCase()}">${c.role}</span>
          </div>
        </div>
        <div class="modal-section-border">
          <div class="modal-section-title">Data</div>
          <div class="modal-data-grid">
            <div class="modal-data-item"><div class="md-label">身長</div><div class="md-value">${c.h}cm</div></div>
            <div class="modal-data-item"><div class="md-label">Style</div><div class="md-value">${c.style}</div></div>
            <div class="modal-data-item"><div class="md-label">Overall</div><div class="md-value">${ov(c)}</div></div>
            <div class="modal-data-item"><div class="md-label">Role</div><div class="md-value">${c.role}</div></div>
          </div>
        </div>
        <div>
          <div class="modal-section-title">Combat Abilities</div>
          <div class="modal-ab-row"><span class="modal-ab-name">Power</span>
            <div class="modal-ab-track"><div class="modal-ab-fill power" data-w="${c.pw}"></div></div>
            <span class="modal-ab-val">${c.pw}</span></div>
          <div class="modal-ab-row"><span class="modal-ab-name">Speed</span>
            <div class="modal-ab-track"><div class="modal-ab-fill speed" data-w="${c.sp}"></div></div>
            <span class="modal-ab-val">${c.sp}</span></div>
          <div class="modal-ab-row"><span class="modal-ab-name">Technique</span>
            <div class="modal-ab-track"><div class="modal-ab-fill technique" data-w="${c.te}"></div></div>
            <span class="modal-ab-val">${c.te}</span></div>
          <div class="modal-ab-row"><span class="modal-ab-name">Stamina</span>
            <div class="modal-ab-track"><div class="modal-ab-fill stamina" data-w="${c.st}"></div></div>
            <span class="modal-ab-val">${c.st}</span></div>
        </div>
        ${c.profile?`<div class="modal-section-border">
          <div class="modal-section-title">Character</div>
          <div class="modal-profile-section">
            <div class="modal-profile-item"><div class="mp-label">性格</div><div class="mp-text">${c.profile.personality}</div></div>
            <div class="modal-profile-item"><div class="mp-label">経歴</div><div class="mp-text">${c.profile.background}</div></div>
            <div class="modal-profile-item"><div class="mp-label">得意技</div><div class="mp-text">${c.profile.specialty}</div></div>
            <div class="modal-profile-item"><div class="mp-label">弱点</div><div class="mp-text">${c.profile.weakness}</div></div>
          </div>
        </div>`:''}
      </div>
    </div>
    <div class="modal-lockin-wrap"><button class="btn-lockin" id="mLock">✦ RING IN ✦</button></div>
  </div>`;
  mo.classList.add('show');
  // Animate bars
  requestAnimationFrame(()=>{requestAnimationFrame(()=>{
    mo.querySelectorAll('.modal-ab-fill').forEach(b=>{b.style.width=b.dataset.w+'%'})
  })});
  document.getElementById('mClose').addEventListener('click',closeModal);
  // RING IN handler (shared)
  const doLockin=()=>{
    sfx.lockIn();
    if(!S.selL){S.selL=charId}else if(!S.selR){S.selR=charId}
    closeModal();
    renderSelect();
  };
  document.getElementById('mLock').addEventListener('click',doLockin);
  // Image section click as alternative RING IN
  const imgSec=document.getElementById('mImgSec');
  if(imgSec)imgSec.addEventListener('click',doLockin);
  // Enter key as alternative RING IN
  S._modalKeyHandler=e=>{
    if(e.key==='Enter'){e.preventDefault();doLockin()}
    if(e.key==='Escape')closeModal();
  };
  document.addEventListener('keydown',S._modalKeyHandler);
  mo.addEventListener('click',e=>{if(e.target===mo)closeModal()});
}
function closeModal(){
  const mo=document.getElementById('modalOverlay');
  mo.classList.remove('show');S.confirmId=null;
  if(S._modalKeyHandler){document.removeEventListener('keydown',S._modalKeyHandler);S._modalKeyHandler=null}
}

// ═══ START MATCH ═══
function startMatch(){
  const mk=c=>({...c,hp:Math.round(c.st*1.9),mhp:Math.round(c.st*1.9),kickoutCount:0});
  S.L=mk(C.find(c=>c.id===S.selL));S.R=mk(C.find(c=>c.id===S.selR));
  S.turn=1;S.mom=0;S.prevMom=0;S.log=[];S.winner=null;S.finType=null;S.anim=false;
  S.halfTrig={l:false,r:false};S.qtrTrig={l:false,r:false};S.dangerTrig={l:false,r:false};
  S.awaitingFinishClick=false;S.pendingFinishResult=null;stopDrone();
  S.screen='MATCH';renderMatchWithIntro();
}

// ═══ MATCH RENDER ═══
function renderMatch(){
  const ct=document.getElementById('screenContainer'),L=S.L,R=S.R,ph=phase(S.turn);
  const hdr=document.querySelector('.site-title');if(hdr)hdr.textContent='GAKUEN JOSHI PROWRES';
  const sub=document.getElementById('headerSub');if(sub)sub.textContent='学園女子プロレス — Turn-Based Simulator';
  const mPct=clamp(50+S.mom*0.5,5,95),over=!!S.winner;
  function panelCls(f,side){
    const pct=f.hp/f.mhp*100;
    let cls='fighter-panel '+side;
    if(pct<=33)cls+=' critical';
    else if(pct<=66)cls+=' exhausted';
    return cls;
  }
  function fHTML(f,side){
    const pct=Math.max(0,f.hp/f.mhp*100),hc=pct>66?'high':pct>33?'mid':'low',rc=f.role.toLowerCase();
    const hpBarCls=pct<=66&&pct>33?' exhausted-glow':'';
    const stats=[{k:'power',l:'POWER',v:f.pw},{k:'speed',l:'SPEED',v:f.sp},
      {k:'technique',l:'TEC',v:f.te},{k:'stamina',l:'STA',v:f.st}];
    return `<div class="${panelCls(f,side)}" id="panel-${side}">
      <div class="danger-overlay" id="danger-${side}">DANGER</div>
      <div class="portrait-area" id="port-${side}">
        <img src="image/upper_${f.id}.jpg" alt="${f.name}" id="img-${side}"
          onerror="this.style.display='none';this.nextElementSibling.style.display='flex'">
        <div class="portrait-placeholder" style="display:none">${silSVG}<span>${f.name}</span></div>
        <div class="speech-bubble" id="sp-${side}"></div>
      </div><div class="fighter-info">
        <div class="f-name-row"><span class="f-name">${f.name}</span>
          <span class="f-role-tag ${rc}">${f.role}</span></div>
        <div class="f-style">${f.style} / ${f.h}cm</div>
        <div class="hp-section"><div class="hp-header"><span class="hp-label">HP</span>
          <span class="hp-value" id="hpv-${side}">${Math.max(0,f.hp)} / ${f.mhp}</span></div>
          <div class="hp-bar${hpBarCls}" id="hpbar-${side}"><div class="hp-fill ${hc}" id="hpf-${side}" style="width:${pct}%"></div></div></div>
        <div class="ability-bars">${stats.map(s=>`<div class="ab-row"><span class="ab-name">${s.l}</span>
          <div class="ab-track"><div class="ab-fill ${s.k}" style="width:${s.v}%"></div></div>
          <span class="ab-val">${s.v}</span></div>`).join('')}</div></div></div>`}
  const logH=S.log.map(e=>{let c='log-entry';
    if(e.includes('★')||e.includes('⏰'))c+=' finish';else if(e.includes('カウント'))c+=' system';
    return `<div class="${c}">${e}</div>`}).join('');
  ct.innerHTML=`<div class="match-grid" id="matchGrid">${fHTML(L,'left')}
    <div class="center-panel">
      <div class="top-line"><span class="turn-label">TURN ${S.turn}</span>
        <span class="phase-pill" id="pill">${ph.name}</span></div>
      <div class="narration-box" id="narBox"><div class="nar-empty">試合開始 — NEXT TURNを押してください</div></div>
      <div class="move-box"><div class="move-label">Current Move</div>
        <div class="move-value" id="moveV">---</div></div>
      <div class="momentum-section"><div class="momentum-header">Momentum</div>
        <div class="momentum-bar"><div class="m-left" id="mL" style="width:${mPct}%"></div>
          <div class="m-right" id="mR" style="width:${100-mPct}%"></div></div>
        <div class="momentum-names"><span>${L.name}</span><span>${R.name}</span></div></div>
      <div class="log-section"><div class="log-header">Battle Log</div>
        <div class="log-box" id="logBox">${logH}</div></div>
    </div>${fHTML(R,'right')}</div>
    <div class="action-bar-spacer"></div>
    <div class="action-bar"><button class="btn-next" id="nBtn" ${over||S.anim?'disabled':''}>
      ${over?(S.winner==='draw'?'DRAW!':`${(S.winner==='left'?L:R).name} WIN!`):'▶  NEXT TURN'}</button></div>`;
  if(!over&&!S.anim)document.getElementById('nBtn').addEventListener('click',nextTurn);
}

// ═══ TURN LOGIC ═══
function nextTurn(){
  if(S.winner||S.anim)return;S.anim=true;
  const btn=document.getElementById('nBtn');if(btn){btn.disabled=true;btn.style.animation='none';}
  const L=S.L,R=S.R,ph=phase(S.turn),prevPh=S.turn>1?phase(S.turn-1).name:ph.name;
  // Attacker
  let lCh=50+(S.mom*0.3)+(L.sp-R.sp)*0.15;lCh=clamp(lCh,20,80);
  const as=Math.random()*100<lCh?'left':'right',ds=as==='left'?'right':'left';
  const atk=as==='left'?L:R,def=ds==='left'?L:R;
  const mv=selMove(atk.style,S.turn),big=mv.d>=14;
  // Damage (v3.2: mental 0.035)
  const base=mv.d+(atk.pw*0.15)+(atk.te*0.1),defense=(def.st*0.1)+(def.mn*0.035);
  const mAdv=as==='left'?S.mom:-S.mom,mMod=1+(mAdv*0.003);
  const rF=0.85+(Math.random()*0.3),raw=(base-defense)*mMod*rF*ph.mult;
  const dmg=Math.max(4,Math.round(raw));
  // Commentary
  const v={a:atk.name,d:def.name,m:mv.n,v:dmg,w:''};
  const atkLine=big?tpl(pk(CMT.atk.big),v):tpl(pk(CMT.atk[ph.name]),v);
  const dLvl=dmg<=8?'light':dmg<=14?'medium':'heavy';
  const dmgLine=tpl(pk(CMT.dmg[dLvl]),v);
  // Tempo
  let tempo=ph.tempo;if(big)tempo+=500;
  const hpAfter=def.hp-dmg;
  if(hpAfter>0&&hpAfter/def.mhp<=0.25)tempo+=300;
  const t=p=>tempo*p;

  // Phase change
  if(ph.name!==prevPh){
    const pill=document.getElementById('pill');
    if(pill){pill.textContent=ph.name;pill.classList.add('flash');setTimeout(()=>pill.classList.remove('flash'),600)}
    sfx.phaseChg();
  }

  // ── Step 1: Attacker flash ──
  sfx.ready();
  const ap=document.getElementById(`panel-${as}`);if(ap)ap.classList.add('flash-atk');
  if(Math.random()<0.3){const ct2=big?pk(CMT.atkC.big):pk(CMT.atkC.normal);showSp(as,ct2,'t-atk')}

  // ── Step 2: Move name ──
  setTimeout(()=>{
    const mv2=document.getElementById('moveV');
    if(mv2){mv2.textContent=`${atk.name}の${mv.n}`;mv2.classList.remove('move-pop');void mv2.offsetWidth;mv2.classList.add('move-pop')}
    const box=document.getElementById('narBox');
    if(box){box.innerHTML=`<div class="nar-line nar-main" id="nM">${atkLine}</div>
      <div class="nar-line nar-dmg" id="nD"></div><div class="nar-line nar-react" id="nR"></div>`;
      setTimeout(()=>{const e=document.getElementById('nM');if(e)e.classList.add('show')},30)}
  },t(0.2));

  // ── Step 3: Hit ──
  setTimeout(()=>{
    hitSE(mv.c,dmg);
    if(big)setTimeout(()=>{mkNoise(0.3,0.1);osc('sine',80,40,0.4,0.06)},100);
    def.hp=Math.max(0,def.hp-dmg);
    // 3-tier shake
    const img=document.getElementById(`img-${ds}`);
    if(img&&img.style.display!=='none'){
      const tier=dmg<=8?'s':dmg<=14?'m':'l';
      const flip=ds==='left';
      const cls=`shake-${tier}${flip?'-flip':''}`;
      img.classList.remove('shake-s','shake-m','shake-l','shake-s-flip','shake-m-flip','shake-l-flip');
      void img.offsetWidth;img.classList.add(cls);
    }
    // Large damage: screen shake + HP flash + panel flash
    if(dmg>=15){
      const mg=document.getElementById('matchGrid');
      if(mg){mg.classList.remove('screen-shake');void mg.offsetWidth;mg.classList.add('screen-shake')}
      const hpbar=document.getElementById(`hpbar-${ds}`);
      if(hpbar){hpbar.style.background='rgba(255,255,255,0.4)';setTimeout(()=>{hpbar.style.background=''},100)}
    }
    // Medium+ damage: panel red flash
    if(dmg>=9){
      const dp=document.getElementById(`panel-${ds}`);
      if(dp){dp.classList.add('flash-hit');setTimeout(()=>dp.classList.remove('flash-hit'),150)}
    }
    updHP(ds,def);
    // HP state classes
    updPanelState(ds,def);
    // DANGER check
    const sk=ds==='left'?'l':'r';
    if(def.hp>0&&def.hp/def.mhp<=0.2&&!S.dangerTrig[sk]){
      S.dangerTrig[sk]=true;
      const dng=document.getElementById(`danger-${ds}`);
      if(dng){dng.classList.add('show');setTimeout(()=>dng.classList.remove('show'),1200)}
    }
    // Defender speech
    const hr=def.hp/def.mhp,rl=hr>0.66?'high':hr>0.33?'mid':'low';
    showSp(ds,pk(CMT.defR[rl]),'t-def');
    if(ap)ap.classList.remove('flash-atk');
  },t(0.45));

  // ── Step 4: Damage line + situation ──
  setTimeout(()=>{
    const nD=document.getElementById('nD');if(nD){nD.textContent=dmgLine;nD.classList.add('show')}
    // Momentum
    S.prevMom=S.mom;const dir=as==='left'?1:-1;
    S.mom=clamp(S.mom+(dmg*0.5)*dir,-100,100);
    const mPct=clamp(50+S.mom*0.5,5,95);
    const mL=document.getElementById('mL');if(mL)mL.style.width=mPct+'%';
    const mR=document.getElementById('mR');if(mR)mR.style.width=(100-mPct)+'%';
    // Situation
    let sit='';const hr=def.hp/def.mhp,skk=ds==='left'?'l':'r';
    if(hr<=0.25&&!S.qtrTrig[skk]){S.qtrTrig[skk]=true;sit=tpl(pk(CMT.sit.quarter),v)}
    else if(hr<=0.5&&!S.halfTrig[skk]){S.halfTrig[skk]=true;sit=tpl(pk(CMT.sit.half),v)}
    else if(Math.abs(S.mom)>=80)sit=tpl(pk(CMT.sit.dominant),v);
    else if((S.prevMom>0&&S.mom<0)||(S.prevMom<0&&S.mom>0))sit=tpl(pk(CMT.sit.reversal),v);
    if(sit){const nR=document.getElementById('nR');if(nR){nR.textContent=sit;nR.classList.add('show')}}
    // Log
    let log=`T${S.turn} [${ph.name}] ${atk.name}の${mv.n} → ${def.name}に${dmg}dmg`;
    // Rollup?
    if(mv.c==='rollup'&&def.hp>0&&(def.hp/def.mhp)<=0.25){doRollup(def,atk,ds,as,mv,log,v,t);return}
    // KO?
    if(def.hp<=0){doFinish(atk,def,as,ds,mv,log,v,t);return}
    S.log.unshift(log);S.log=S.log.slice(0,12);
    S.turn++;
    if(S.turn>MAX_T){doTimeout(t);return}
    endAnim();
  },t(0.7));
}

function doRollup(def,atk,ds,as,mv,log,v,t){
  // v3.5: Pre-determine result, then show finish click
  const isSuccess=Math.random()<0.15;
  // Count 1
  sfx.count();
  const box0=document.getElementById('narBox');
  showCountText('ワン！','gold');
  setTimeout(()=>{
    // Count 2
    sfx.count();
    showCountText('ツー！','red-gold');
    if(box0)box0.innerHTML=`<div class="nar-line nar-finish show">丸め込んだ！ 入るか！？</div>`;
    setTimeout(()=>{
      // Enter finish click wait
      S.awaitingFinishClick=true;
      S.pendingFinishResult={type:'丸め込み',isKickout:isSuccess?false:true,
        def,atk:atk,moveName:mv.n,defSide:ds,atkSide:as,log};
      showFinishClickBtn('丸め込み',v);
    },1000);
  },800);
}

function getKickoutRecoveryHP(def){
  const initialHP=Math.round(def.st*1.9);
  const ph=phase(S.turn);
  if(ph.name==='Climax'){return Math.max(1,Math.round(initialHP*0.08))}
  return 1;
}
function applyClimaxReturnEffects(ds,def,v){
  const ph=phase(S.turn);
  if(ph.name!=='Climax')return;
  // Gold aura on defender panel
  const dp=document.getElementById(`panel-${ds}`);
  if(dp){dp.classList.add('gold-aura');setTimeout(()=>dp.classList.remove('gold-aura'),1500)}
  // Extra narration
  setTimeout(()=>{
    const box=document.getElementById('narBox');
    if(box){const extra=document.createElement('div');extra.className='nar-line nar-finish show';
      extra.textContent=tpl(pk(CMT.sit.climaxReturn),v);box.appendChild(extra)}
  },300);
  // Heartbeat SE
  sfx.heartbeatSE();
}
function doFinish(atk,def,as,ds,mv,log,v,t){
  // v3.2: mental 0.14
  let guCh=30-(def.mn*0.14);if(mv.c==='submission')guCh+=20;guCh=clamp(guCh,5,50);
  const ft=Math.random()*100<guCh?'ギブアップ':'フォール';
  v.w=atk.name;

  // v3.5: Pre-determine kickout/escape result BEFORE showing animation
  let isKickout=false;
  if(ft==='フォール'){
    let kickoutChance=(def.mn/100)*0.40;
    kickoutChance=clamp(kickoutChance,0.05,0.40);
    if(def.kickoutCount>=2)kickoutChance=0;
    if(Math.random()<kickoutChance){
      isKickout=true;
      // v3.5: HP recovery deferred to post-click (resolveFinishClick)
    }
  }else{
    let escapeChance=(def.mn/100)*0.35;
    escapeChance=clamp(escapeChance,0.05,0.35);
    if(def.kickoutCount>=2)escapeChance=0;
    if(Math.random()<escapeChance){
      isKickout=true;
      // v3.5: HP recovery deferred to post-click (resolveFinishClick)
    }
  }

  // Store pending result
  const pending={type:ft,isKickout,def,atk,moveName:mv.n,defSide:ds,atkSide:as,log};

  // Step 4: Impact flash + "これは…！"
  const flash=document.createElement('div');flash.className='finish-flash';
  document.body.appendChild(flash);setTimeout(()=>flash.remove(),400);
  sfx.finImpact();updHP(ds,def);
  const box0=document.getElementById('narBox');
  if(box0)box0.innerHTML=`<div class="nar-line nar-finish show">これは…！ 決まったかーーーっ！？</div>`;

  if(ft==='フォール'){
    // === FALL FLOW with finish click ===
    // Step F1 (800ms): Cover announcement
    setTimeout(()=>{
      const box=document.getElementById('narBox');
      if(box)box.innerHTML=`<div class="nar-line nar-finish show">${atk.name}がカバーに入った！ レフェリーのカウント！</div>`;
      sfx.count();
    },800);
    // Step F2 (1600ms): "ワン！"
    setTimeout(()=>{
      showCountText('ワン！','gold');
      sfx.count();
      // Light shake on defender
      const img=document.getElementById(`img-${ds}`);
      if(img&&img.style.display!=='none'){
        const cls=ds==='left'?'shake-s-flip':'shake-s';
        img.classList.remove('shake-s','shake-s-flip');void img.offsetWidth;img.classList.add(cls);
      }
    },1600);
    // Step F3 (2600ms): "ツー！"
    setTimeout(()=>{
      showCountText('ツー！','red-gold');
      sfx.count();mkNoise(0.15,0.06);
      const box=document.getElementById('narBox');
      if(box)box.innerHTML=`<div class="nar-line nar-finish show">ツーーーーっ！！</div>`;
      // Stronger shake on defender
      const img=document.getElementById(`img-${ds}`);
      if(img&&img.style.display!=='none'){
        const cls=ds==='left'?'shake-m-flip':'shake-m';
        img.classList.remove('shake-m','shake-m-flip');void img.offsetWidth;img.classList.add(cls);
      }
    },2600);
    // Step F4 (3600ms): Finish click wait
    setTimeout(()=>{
      S.awaitingFinishClick=true;
      S.pendingFinishResult=pending;
      showFinishClickBtn('フォール',v);
    },3600);

  }else{
    // === GIVEUP FLOW with finish click ===
    // Step G1 (800ms): Lock narration
    setTimeout(()=>{
      const box=document.getElementById('narBox');
      if(box)box.innerHTML=`<div class="nar-line nar-finish show">${atk.name}、${mv.n}をがっちりロック！</div>`;
      osc('sawtooth',100,200,0.3,0.08);
      const dp=document.getElementById(`panel-${ds}`);
      if(dp){dp.classList.add('flash-hit');setTimeout(()=>dp.classList.remove('flash-hit'),200)}
    },800);
    // Step G2 (1800ms): Agony
    setTimeout(()=>{
      const box=document.getElementById('narBox');
      if(box)box.innerHTML=`<div class="nar-line nar-finish show">${def.name}の表情が歪む…！ 極まっている！</div>`;
      osc('sawtooth',80,150,0.5,0.06);
      // Sustained small shake on defender
      const img=document.getElementById(`img-${ds}`);
      if(img&&img.style.display!=='none'){
        const cls=ds==='left'?'shake-s-flip':'shake-s';
        img.classList.remove('shake-s','shake-s-flip');void img.offsetWidth;img.classList.add(cls);
        setTimeout(()=>{img.classList.remove('shake-s','shake-s-flip');void img.offsetWidth;img.classList.add(cls)},300);
      }
    },1800);
    // Step G3 (2800ms): Finish click wait
    setTimeout(()=>{
      S.awaitingFinishClick=true;
      S.pendingFinishResult=pending;
      showFinishClickBtn('ギブアップ',v);
    },2800);
  }
}

function doTimeout(t){
  const L=S.L,R=S.R,lr=L.hp/L.mhp,rr=R.hp/R.mhp;
  if(lr>rr)S.winner='left';else if(rr>lr)S.winner='right';else S.winner='draw';
  S.finType='判定';sfx.gong();
  const w=S.winner==='draw'?'':(S.winner==='left'?L:R).name;
  const key=S.winner==='draw'?'finDraw':'finJudge';
  setTimeout(()=>{
    const box=document.getElementById('narBox');
    if(box)box.innerHTML=`<div class="nar-line nar-finish show">${tpl(pk(CMT.sit[key]),{w})}</div>`;
    const tl=`⏰ タイムアップ！ ${S.winner==='draw'?'ドロー':w+'の判定勝ち'}！`;
    S.log.unshift(tl);S.log=S.log.slice(0,12);sfx.finChime();
  },800);
  setTimeout(()=>showResult(),3000);
}

function updHP(side,f){
  const pct=Math.max(0,f.hp/f.mhp*100),hc=pct>66?'high':pct>33?'mid':'low';
  const fill=document.getElementById(`hpf-${side}`);if(fill){fill.style.width=pct+'%';fill.className=`hp-fill ${hc}`}
  const val=document.getElementById(`hpv-${side}`);if(val)val.textContent=`${Math.max(0,f.hp)} / ${f.mhp}`;
  // HP bar glow
  const hpbar=document.getElementById(`hpbar-${side}`);
  if(hpbar){
    hpbar.classList.remove('exhausted-glow');
    if(pct<=66&&pct>33)hpbar.classList.add('exhausted-glow');
  }
}
function updPanelState(side,f){
  const panel=document.getElementById(`panel-${side}`);if(!panel)return;
  const pct=f.hp/f.mhp*100;
  panel.classList.remove('exhausted','critical');
  if(pct<=33)panel.classList.add('critical');
  else if(pct<=66)panel.classList.add('exhausted');
}
function showSp(side,text,cls){
  const el=document.getElementById(`sp-${side}`);if(!el)return;
  el.textContent=text;el.className=`speech-bubble ${cls} visible`;
  setTimeout(()=>el.classList.remove('visible'),1800);
}
function endAnim(){
  S.anim=false;
  const btn=document.getElementById('nBtn');if(btn){btn.disabled=false;btn.addEventListener('click',nextTurn)}
  updLog();
}
function updLog(){
  const lb=document.getElementById('logBox');if(!lb)return;
  lb.innerHTML=S.log.map(e=>{let c='log-entry';
    if(e.includes('★')||e.includes('⏰'))c+=' finish';else if(e.includes('カウント'))c+=' system';
    return `<div class="${c}">${e}</div>`}).join('');
}

function showResult(){
  S.anim=false;
  const btn=document.getElementById('nBtn');
  if(btn){btn.disabled=true;btn.textContent=S.winner==='draw'?'DRAW!':`${(S.winner==='left'?S.L:S.R).name} WIN!`}
  updLog();renderResult();
}

// ═══ RESULT (v3.2: phased animation with bust image + victory lines) ═══
function renderResult(){
  const el=document.getElementById('resultOverlay'),L=S.L,R=S.R;
  const isDraw=S.winner==='draw';
  const winner=isDraw?null:(S.winner==='left'?L:R);
  const wName=isDraw?'DRAW':winner.name;
  const wType=isDraw?'タイムアップ — 引き分け':`${S.finType}勝ち！`;
  const vLine=winner?pk(winner.vl):'';

  if(isDraw){
    el.innerHTML=`<div class="result-box" id="rBox">
      <div class="result-draw-content">
        <div class="result-winner" id="rWinner">DRAW</div>
        <div class="result-type" id="rType">${wType}</div>
      </div>
      <button class="btn-end" id="eBtn">BACK TO SELECT</button></div>`;
  }else{
    el.innerHTML=`<div class="result-box" id="rBox">
      <div class="result-content">
        <div class="result-image" id="rImg">
          <img src="image/bust_${winner.id}.jpg" alt="${winner.name}"
            onerror="this.style.display='none';this.nextElementSibling.style.display='flex'">
          <div class="result-image-placeholder" style="display:none">${silSVG}</div>
        </div>
        <div class="result-text">
          <div class="result-winner" id="rWinner">${wName}</div>
          <div class="result-type" id="rType">${wType}</div>
          <div class="result-quote" id="rQuote"></div>
        </div>
      </div>
      <button class="btn-end" id="eBtn">BACK TO SELECT</button></div>`;
  }
  el.classList.add('show');

  // Phase 1 (0ms): overlay fade in
  sfx.finChime();
  requestAnimationFrame(()=>{el.classList.add('visible')});

  // Phase 2 (800ms): box appears
  setTimeout(()=>{
    const rBox=document.getElementById('rBox');if(rBox)rBox.classList.add('visible');
    if(!isDraw){
      const rImg=document.getElementById('rImg');if(rImg)rImg.classList.add('visible');
    }
    sfx.victoryFanfare();
  },800);

  // Phase 3 (1500ms): winner name + type
  setTimeout(()=>{
    const rW=document.getElementById('rWinner');if(rW)rW.classList.add('visible');
    const rT=document.getElementById('rType');if(rT)rT.classList.add('visible');
  },1500);

  // Phase 4 (2200ms): victory line typewriter
  if(!isDraw){
    setTimeout(()=>{
      const rQ=document.getElementById('rQuote');if(!rQ)return;
      rQ.classList.add('visible');
      const fullText=`「${vLine}」`;
      let idx=0;
      const tw=setInterval(()=>{
        idx++;rQ.textContent=fullText.slice(0,idx);
        if(idx>=fullText.length)clearInterval(tw);
      },40);
    },2200);
  }

  // Phase 5 (3500ms): back button
  setTimeout(()=>{
    const eBtn=document.getElementById('eBtn');if(eBtn){eBtn.classList.add('visible');eBtn.addEventListener('click',resetSelect)}
  },3500);
}
function hideResult(){const el=document.getElementById('resultOverlay');el.classList.remove('show','visible');el.innerHTML=''}

function resetSelect(){
  Object.assign(S,{screen:'SELECT',selL:null,selR:null,confirmId:null,turn:1,mom:0,prevMom:0,
    L:null,R:null,log:[],winner:null,finType:null,anim:false,
    halfTrig:{l:false,r:false},qtrTrig:{l:false,r:false},dangerTrig:{l:false,r:false},
    awaitingFinishClick:false,pendingFinishResult:null});
  stopDrone();
  hideResult();render();
}

// ═══ MATCH INTRO SEQUENCE (v3.3 §6.6) ═══
const INTRO_LINES={
  main:["{l}  vs  {r}！ 注目の一戦が始まる！","さあ対戦カードが決定！ {l} 対 {r}！","{l} と {r}！ 両者の実力は拮抗している！"],
  gong:["ゴングが鳴った！ 試合開始だーーっ！","ゴング！ いよいよ試合開始！","カーーーン！ ゴングと共に試合が始まった！"],
  extra:["両者、リング中央で向かい合う！ さあ、どんな展開になるか！","まずはお互いの出方を探る展開か！","序盤からどう攻めるか、注目だ！"]
};

function renderMatchWithIntro(){
  renderMatch();
  const btn=document.getElementById('nBtn');if(btn)btn.disabled=true;
  const box=document.getElementById('narBox');
  const v={l:S.L.name,r:S.R.name};

  // Phase 2 (600ms): VS announcement + FIGHT SE
  setTimeout(()=>{
    sfx.fightStart();
    if(box)box.innerHTML=`<div class="nar-line nar-main show">${tpl(pk(INTRO_LINES.main),v)}</div>`;
  },600);

  // Phase 3 (2200ms): Gong + flash
  setTimeout(()=>{
    sfx.gongStart();
    if(box)box.innerHTML=`<div class="nar-line nar-main show">${tpl(pk(INTRO_LINES.gong),v)}</div>`;
    const flash=document.createElement('div');flash.className='finish-flash';
    document.body.appendChild(flash);setTimeout(()=>flash.remove(),400);
  },2200);

  // Phase 4 (3500ms): Extra commentary
  setTimeout(()=>{
    if(box)box.innerHTML=`<div class="nar-line nar-main show">${tpl(pk(INTRO_LINES.extra),v)}</div>`;
  },3500);

  // Phase 5 (4500ms): Enable button
  setTimeout(()=>{
    if(box)box.innerHTML=`<div class="nar-empty">NEXT TURNを押して試合開始</div>`;
    const btn2=document.getElementById('nBtn');
    if(btn2){btn2.disabled=false;btn2.addEventListener('click',nextTurn);
      btn2.style.animation='btnPulse 1.5s ease-in-out infinite';}
  },4500);
}

function render(){if(S.screen==='SELECT'){renderSelect();hideResult()}
  else if(S.screen==='MATCH'){renderMatch();hideResult()}}
render();
</script>
</body>
</html>
